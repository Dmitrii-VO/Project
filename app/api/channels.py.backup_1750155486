from flask import Blueprint, request, jsonify
from app.services.auth_service import auth_service
from app.services.security_service import security_service
from app.utils.decorators import require_telegram_auth
from app.models.database import db_manager
from app.config.settings import Config
from datetime import datetime
import logging

logger = logging.getLogger(__name__)
channels_bp = Blueprint('channels', __name__)


@channels_bp.route('/search', methods=['POST'])
@require_telegram_auth
def search_channel():
    """–ü–æ–∏—Å–∫ –∫–∞–Ω–∞–ª–∞ —á–µ—Ä–µ–∑ Telegram API"""
    try:
        data = request.get_json()
        if not data or 'username' not in data:
            return jsonify({'success': False, 'error': 'Username –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω'}), 400

        username = data['username'].strip().lstrip('@')
        user_id = auth_service.get_current_user_id()

        # –ó–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã–∑–æ–≤ Telegram API
        # –ü–æ–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
        return jsonify({
            'success': True,
            'channel': {
                'id': f'fake_id_{username}',
                'username': username,
                'title': f'–ö–∞–Ω–∞–ª @{username}',
                'description': '–û–ø–∏—Å–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞',
                'subscribers_count': 1000,
                'verified': False
            },
            'user_permissions': {
                'is_admin': True
            }
        })

    except Exception as e:
        logger.error(f"Search channel error: {e}")
        return jsonify({
            'success': False,
            'error': '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'
        }), 500


@channels_bp.route('', methods=['POST'])
@require_telegram_auth
def add_channel():
    """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –º–æ–¥–µ—Ä–∞—Ü–∏–µ–π"""
    try:
        data = request.get_json()
        if not data:
            return jsonify({'success': False, 'error': 'JSON data required'}), 400

        username = data.get('username', '').strip()
        telegram_user_id = auth_service.get_current_user_id()

        if not username:
            return jsonify({'success': False, 'error': 'Username –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω'}), 400

        # –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_db_id = db_manager.ensure_user_exists(telegram_user_id)

        if not user_db_id:
            return jsonify({'success': False, 'error': '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'}), 500

        cleaned_username = username.lstrip('@')

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –ª–∏ —É–∂–µ –∫–∞–Ω–∞–ª
        existing_channel = db_manager.execute_query("""
                                                    SELECT c.id, c.title
                                                    FROM channels c
                                                             JOIN users u ON c.owner_id = u.id
                                                    WHERE c.username = ?
                                                      AND u.telegram_id = ?
                                                    """, (cleaned_username, telegram_user_id), fetch_one=True)

        if existing_channel:
            return jsonify({
                'success': False,
                'error': f'–ö–∞–Ω–∞–ª @{cleaned_username} —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤–∞–º–∏'
            })

        # === –ì–ï–ù–ï–†–ê–¶–ò–Ø –ö–û–î–ê –í–ï–†–ò–§–ò–ö–ê–¶–ò–ò ===
        import string
        import random
        import secrets

        def generate_verification_code():
            """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ #add123abc"""
            chars = string.ascii_lowercase + string.digits
            random_part = ''.join(random.choices(chars, k=6))
            return f"#add{random_part}"

        verification_code = generate_verification_code()

        # === –î–û–ë–ê–í–õ–Ø–ï–ú –ö–ê–ù–ê–õ –í –ë–ê–ó–£ –° –ö–û–î–û–ú –í–ï–†–ò–§–ò–ö–ê–¶–ò–ò ===
        current_time = datetime.now().isoformat()

        channel_id = db_manager.execute_query("""
                                              INSERT INTO channels (telegram_id, username, title, description, owner_id,
                                                                    category, created_at, verification_code, status)
                                              VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
                                              """, (
                                                  f'fake_id_{cleaned_username}',
                                                  cleaned_username,
                                                  data.get('title', f'–ö–∞–Ω–∞–ª @{cleaned_username}'),
                                                  data.get('description', ''),
                                                  user_db_id,
                                                  data.get('category', 'general'),
                                                  current_time,
                                                  verification_code,
                                                  'pending_verification'
                                              ))

        if channel_id:
            logger.info(
                f"‚úÖ Channel @{cleaned_username} added with verification code {verification_code} for user {telegram_user_id}")

            # === –í–û–ó–í–†–ê–©–ê–ï–ú –û–¢–í–ï–¢ –° –ò–ù–°–¢–†–£–ö–¶–ò–Ø–ú–ò –ü–û –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ô –ú–û–î–ï–†–ê–¶–ò–ò ===
            return jsonify({
                'success': True,
                'message': f'–ö–∞–Ω–∞–ª @{cleaned_username} –¥–æ–±–∞–≤–ª–µ–Ω! –î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–¥ {verification_code} –≤ –∫–∞–Ω–∞–ª.',
                'verification_code': verification_code,
                'verification_instructions': f'''–î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞:

1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥: {verification_code}
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –≤ –≤–∞—à Telegram –∫–∞–Ω–∞–ª @{cleaned_username}
3. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç –∫–∞–Ω–∞–ª –≤ —Ç–µ—á–µ–Ω–∏–µ 1-2 –º–∏–Ω—É—Ç

–ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∏–º–µ–Ω–Ω–æ –≤ —Ç–æ–º –∫–∞–Ω–∞–ª–µ, –∫–æ—Ç–æ—Ä—ã–π –≤—ã –¥–æ–±–∞–≤–ª—è–µ—Ç–µ.
–ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞ –∫–∞–Ω–∞–ª –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω.''',
                'channel': {
                    'id': channel_id,
                    'username': cleaned_username,
                    'title': data.get('title', f'–ö–∞–Ω–∞–ª @{cleaned_username}'),
                    'subscribers_count': 1000,
                    'status': 'pending_verification',
                    'verification_code': verification_code,
                    'is_verified': False
                }
            })
        else:
            return jsonify({
                'success': False,
                'error': '–ö–∞–Ω–∞–ª –Ω–µ –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö'
            })

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞: {e}")
        return jsonify({
            'success': False,
            'error': f'–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: {str(e)}'
        }), 500


@channels_bp.route('/my', methods=['GET'])
@require_telegram_auth
def get_my_channels():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –º–æ–∏—Ö –∫–∞–Ω–∞–ª–æ–≤"""
    try:
        telegram_user_id = auth_service.get_current_user_id()

        user_db_id = db_manager.ensure_user_exists(telegram_user_id)
        if not user_db_id:
            return jsonify({
                'success': False,
                'channels': [],
                'total': 0,
                'message': '–û—à–∏–±–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'
            }), 500

        # –ü–æ–ª—É—á–∞–µ–º –∫–∞–Ω–∞–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        channels = db_manager.execute_query("""
                                            SELECT c.*, u.username as owner_username, u.telegram_id as owner_telegram_id
                                            FROM channels c
                                                     JOIN users u ON c.owner_id = u.id
                                            WHERE c.owner_id = ?
                                              AND u.telegram_id = ?
                                            ORDER BY c.created_at DESC
                                            """, (user_db_id, telegram_user_id), fetch_all=True)

        if not channels:
            return jsonify({
                'success': True,
                'channels': [],
                'total': 0,
                'message': '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤'
            })

        # –û–±–æ–≥–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª–æ–≤
        enriched_channels = []
        for channel in channels:
            channel_data = dict(channel)

            # –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –ø–æ–ª–µ–π
            if 'subscriber_count' not in channel_data:
                channel_data['subscriber_count'] = channel_data.get('subscribers_count', 0)

            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É
            if channel_data.get('created_at'):
                try:
                    created_at = datetime.fromisoformat(channel_data['created_at'].replace('Z', '+00:00'))
                    channel_data['created_at_formatted'] = created_at.strftime('%d.%m.%Y')
                except:
                    channel_data['created_at_formatted'] = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'

            enriched_channels.append(channel_data)

        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        stats = {
            'total_channels': len(enriched_channels),
            'verified_channels': len([c for c in enriched_channels if c.get('is_verified')]),
            'active_channels': len([c for c in enriched_channels if c.get('is_active')]),
            'total_subscribers': sum(c.get('subscriber_count', 0) or 0 for c in enriched_channels)
        }

        return jsonify({
            'success': True,
            'channels': enriched_channels,
            'total': len(enriched_channels),
            'stats': stats
        })

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞–Ω–∞–ª–æ–≤: {e}")
        return jsonify({
            'success': False,
            'channels': [],
            'error': str(e)
        }), 500


@channels_bp.route('/<int:channel_id>', methods=['DELETE'])
@require_telegram_auth
def delete_channel(channel_id):
    """–£–¥–∞–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞"""
    try:
        telegram_user_id = auth_service.get_current_user_id()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ
        channel = db_manager.execute_query('''
                                           SELECT c.id, c.title, c.username
                                           FROM channels c
                                                    JOIN users u ON c.owner_id = u.id
                                           WHERE c.id = ?
                                             AND u.telegram_id = ?
                                           ''', (channel_id, telegram_user_id), fetch_one=True)

        if not channel:
            return jsonify({
                'success': False,
                'error': '–ö–∞–Ω–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –µ–≥–æ —É–¥–∞–ª–µ–Ω–∏–µ'
            }), 404

        # –£–¥–∞–ª—è–µ–º –∫–∞–Ω–∞–ª
        result = db_manager.execute_query('''
                                          DELETE
                                          FROM channels
                                          WHERE id = ?
                                          ''', (channel_id,))

        if result is not None:
            logger.info(f"–ö–∞–Ω–∞–ª {channel_id} —É–¥–∞–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {telegram_user_id}")
            return jsonify({
                'success': True,
                'message': f'–ö–∞–Ω–∞–ª @{channel["username"]} —É–¥–∞–ª–µ–Ω'
            })
        else:
            return jsonify({
                'success': False,
                'error': '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞'
            }), 500

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞: {e}")
        return jsonify({'success': False, 'error': str(e)}), 500


def telegram_webhook():
    """Webhook –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫–∞–Ω–∞–ª–æ–≤"""
    try:
        from datetime import datetime
        from app.models.database import db_manager
        import logging
        
        logger = logging.getLogger(__name__)
        data = request.get_json()
        
        if not data:
            return jsonify({'ok': True})
        
        logger.info(f"üì® Webhook –ø–æ–ª—É—á–µ–Ω: {data.get('update_id', 'N/A')}")
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–∞–Ω–∞–ª–∞—Ö
        if 'channel_post' in data:
            message = data['channel_post']
            chat = message.get('chat', {})
            chat_id = str(chat.get('id'))
            text = message.get('text', '')
            
            logger.info(f"üì¢ –°–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –∫–∞–Ω–∞–ª–∞ {chat_id}: {text[:50]}...")
            
            # –ò—â–µ–º –∫–∞–Ω–∞–ª—ã —Å –∫–æ–¥–∞–º–∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
            channels = db_manager.execute_query("""
                SELECT id, username, verification_code, telegram_id
                FROM channels 
                WHERE status = 'pending_verification' 
                AND verification_code IS NOT NULL
            """, fetch_all=True)
            
            if channels:
                logger.info(f"üîç –ù–∞–π–¥–µ–Ω–æ {len(channels)} –∫–∞–Ω–∞–ª–æ–≤ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ")
                
                verification_found = False
                
                for channel in channels:
                    verification_code = channel['verification_code']
                    if verification_code and verification_code in text:
                        # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –∫–∞–Ω–∞–ª
                        success = db_manager.execute_query("""
                            UPDATE channels 
                            SET status = 'verified', verified_at = ?, is_verified = 1
                            WHERE id = ?
                        """, (datetime.now().isoformat(), channel['id']))
                        
                        if success:
                            logger.info(f"‚úÖ –ö–∞–Ω–∞–ª {channel['username']} –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω —Å –∫–æ–¥–æ–º {verification_code}!")
                            verification_found = True
                        else:
                            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞ {channel['id']}")
                
                if verification_found:
                    logger.info("üéâ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
                else:
                    logger.info("‚ÑπÔ∏è –ö–æ–¥ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏")
            else:
                logger.info("‚ÑπÔ∏è –ù–µ—Ç –∫–∞–Ω–∞–ª–æ–≤ –æ–∂–∏–¥–∞—é—â–∏—Ö –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏")
        
        return jsonify({'ok': True})
        
    except Exception as e:
        logger = logging.getLogger(__name__)
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ webhook: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({'ok': True})  # –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º ok –¥–ª—è Telegram

        logger.info(f"üì® Webhook –ø–æ–ª—É—á–∏–ª –¥–∞–Ω–Ω—ã–µ: {data}")

        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–∞–Ω–∞–ª–∞—Ö
        if 'channel_post' in data:
            message = data['channel_post']
            chat = message.get('chat', {})
            chat_id = str(chat.get('id'))
            text = message.get('text', '')
            chat_username = chat.get('username', '')

            logger.info(f"üì∫ –°–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –∫–∞–Ω–∞–ª–∞ {chat_username or chat_id}: {text[:100]}...")

            # –ò—â–µ–º –∫–∞–Ω–∞–ª—ã, –æ–∂–∏–¥–∞—é—â–∏–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
            pending_channels = db_manager.execute_query("""
                                                        SELECT id, username, verification_code, title
                                                        FROM channels
                                                        WHERE status = 'pending_verification'
                                                          AND verification_code IS NOT NULL
                                                        """, fetch_all=True)

            if not pending_channels:
                logger.info("üîç –ù–µ—Ç –∫–∞–Ω–∞–ª–æ–≤, –æ–∂–∏–¥–∞—é—â–∏—Ö –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏")
                return jsonify({'ok': True})

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π –∫–∞–Ω–∞–ª –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –µ–≥–æ –∫–æ–¥–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏
            for channel in pending_channels:
                verification_code = channel['verification_code']
                channel_username = channel['username']

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–æ username –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—é –∫–æ–¥–∞
                username_match = (chat_username and chat_username.lower() == channel_username.lower())
                code_in_text = verification_code in text

                if code_in_text and (username_match or chat_username == channel_username):
                    # –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –í–ï–†–ò–§–ò–ö–ê–¶–ò–Ø
                    current_time = datetime.now().isoformat()

                    update_result = db_manager.execute_query("""
                                                             UPDATE channels
                                                             SET status      = 'verified',
                                                                 is_verified = 1,
                                                                 verified_at = ?
                                                             WHERE id = ?
                                                             """, (current_time, channel['id']))

                    if update_result:
                        logger.info(
                            f"‚úÖ –ö–∞–Ω–∞–ª @{channel_username} –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω! –ö–æ–¥: {verification_code}")

                        # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                        # send_verification_notification(channel['id'], channel_username)

                    else:
                        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫–∞–Ω–∞–ª–∞ @{channel_username}")

                elif code_in_text:
                    logger.warning(
                        f"‚ö†Ô∏è –ö–æ–¥ {verification_code} –Ω–∞–π–¥–µ–Ω, –Ω–æ –∫–∞–Ω–∞–ª –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç. –û–∂–∏–¥–∞–ª—Å—è @{channel_username}, –ø–æ–ª—É—á–µ–Ω @{chat_username}")

        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–±—ã—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–µ—Å–ª–∏ –±–æ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–∞–Ω–∞–ª –∫–∞–∫ –∞–¥–º–∏–Ω)
        elif 'message' in data:
            message = data['message']
            chat = message.get('chat', {})

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –∫–∞–Ω–∞–ª–∞
            if chat.get('type') in ['channel', 'supergroup']:
                chat_id = str(chat.get('id'))
                text = message.get('text', '')
                chat_username = chat.get('username', '')

                logger.info(f"üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –≥—Ä—É–ø–ø—ã/–∫–∞–Ω–∞–ª–∞ {chat_username or chat_id}: {text[:100]}...")

                # –ê–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–æ–≤
                pending_channels = db_manager.execute_query("""
                                                            SELECT id, username, verification_code, title
                                                            FROM channels
                                                            WHERE status = 'pending_verification'
                                                              AND verification_code IS NOT NULL
                                                            """, fetch_all=True)

                for channel in pending_channels:
                    verification_code = channel['verification_code']
                    channel_username = channel['username']

                    username_match = (chat_username and chat_username.lower() == channel_username.lower())
                    code_in_text = verification_code in text

                    if code_in_text and username_match:
                        current_time = datetime.now().isoformat()

                        update_result = db_manager.execute_query("""
                                                                 UPDATE channels
                                                                 SET status      = 'verified',
                                                                     is_verified = 1,
                                                                     verified_at = ?
                                                                 WHERE id = ?
                                                                 """, (current_time, channel['id']))

                        if update_result:
                            logger.info(
                                f"‚úÖ –ö–∞–Ω–∞–ª @{channel_username} –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏–µ! –ö–æ–¥: {verification_code}")

        return jsonify({'ok': True})

    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ webhook: {e}")
        import traceback
        logger.error(f"Traceback: {traceback.format_exc()}")
        # –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º ok –¥–ª—è Telegram, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤–æ–∫
        return jsonify({'ok': True})


def send_verification_notification(channel_id, channel_username):
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ–± —É—Å–ø–µ—à–Ω–æ–π –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
    (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –±—É–¥—É—â–µ–≥–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è)
    """
    try:
        # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        # —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞ –∏–ª–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é —Å–∏—Å—Ç–µ–º—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        logger.info(f"üìß –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫–∞–Ω–∞–ª–∞ @{channel_username} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ")
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: {e}")

@channels_bp.route('/webhook', methods=['POST'])
def telegram_webhook():
    """Webhook –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫–∞–Ω–∞–ª–æ–≤"""
    try:
        from datetime import datetime
        import logging

        logger = logging.getLogger(__name__)
        data = request.get_json()

        if not data:
            return jsonify({'ok': True})

        logger.info(f"üì® Webhook –ø–æ–ª—É—á–µ–Ω: {data.get('update_id', 'N/A')}")

        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–∞–Ω–∞–ª–∞—Ö
        if 'channel_post' in data:
            message = data['channel_post']
            chat = message.get('chat', {})
            chat_id = str(chat.get('id'))
            text = message.get('text', '')

            logger.info(f"üì¢ –°–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –∫–∞–Ω–∞–ª–∞ {chat_id}: {text[:50]}...")

            # –ò—â–µ–º –∫–∞–Ω–∞–ª—ã —Å –∫–æ–¥–∞–º–∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
            channels = db_manager.execute_query("""
                SELECT id, username, verification_code, telegram_id
                FROM channels 
                WHERE status = 'pending_verification' 
                AND verification_code IS NOT NULL
            """, fetch_all=True)

            if channels:
                logger.info(f"üîç –ù–∞–π–¥–µ–Ω–æ {len(channels)} –∫–∞–Ω–∞–ª–æ–≤ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ")

                verification_found = False

                for channel in channels:
                    verification_code = channel['verification_code']
                    if verification_code and verification_code in text:
                        # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –∫–∞–Ω–∞–ª
                        db_manager.execute_query("""
                            UPDATE channels 
                            SET status = 'verified', verified_at = ?, is_verified = 1
                            WHERE id = ?
                        """, (datetime.now().isoformat(), channel['id']))

                        logger.info(f"‚úÖ –ö–∞–Ω–∞–ª {channel['username']} –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω —Å –∫–æ–¥–æ–º {verification_code}!")
                        verification_found = True

                if verification_found:
                    logger.info("üéâ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
                else:
                    logger.info("‚ÑπÔ∏è –ö–æ–¥ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏")
            else:
                logger.info("‚ÑπÔ∏è –ù–µ—Ç –∫–∞–Ω–∞–ª–æ–≤ –æ–∂–∏–¥–∞—é—â–∏—Ö –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏")

        return jsonify({'ok': True})

    except Exception as e:
        logger = logging.getLogger(__name__)
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ webhook: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({'ok': True})

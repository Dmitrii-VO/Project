# app/__init__.py - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
import os
import sys
import logging
from flask import Flask

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)


def create_app() -> Flask:
    """–§–∞–±—Ä–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π Flask"""

    # –°–æ–∑–¥–∞–µ–º Flask –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    app = Flask(__name__)

    # –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    try:
        from app.config.settings import Config
        app.config.from_object(Config)

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
        if not Config.validate_config():
            print("‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏!")
            sys.exit(1)

    except ImportError as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: {e}")
        # –ë–∞–∑–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–∞–∫ fallback
        app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY', 'dev-secret-key')
        app.config['DEBUG'] = True

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    try:
        from app.models.database import db_manager
        if not db_manager.init_database():
            print("‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö")
            print("üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ: python sqlite_migration.py")
            sys.exit(1)
    except ImportError as e:
        print(f"‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ú–æ–¥—É–ª—å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: {e}")

    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è middleware
    register_middleware(app)

    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–æ–≤
    register_routes(app)

    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—à–∏–±–æ–∫
    register_error_handlers(app)

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–∏—Å—Ç–µ–º
    initialize_systems(app)

    return app


def register_middleware(app: Flask):
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è middleware"""
    try:
        from app.services.security_service import security_service
        from flask import request, jsonify

        @app.before_request
        def security_middleware():
            """Middleware –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
            client_ip = security_service.get_client_ip()

            # –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö IP
            if client_ip in security_service.blocked_ips:
                security_service.log_security_event('BLOCKED_IP_ACCESS', {
                    'ip': client_ip,
                    'path': request.path,
                    'method': request.method
                })
                return jsonify({'error': 'Access denied'}), 403

            # Rate limiting
            if not security_service.rate_limit_check(f"global_{client_ip}"):
                security_service.suspicious_ips.add(client_ip)
                security_service.log_security_event('RATE_LIMIT_EXCEEDED', {
                    'ip': client_ip,
                    'path': request.path
                })
                return jsonify({'error': 'Too many requests'}), 429

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –∑–∞–ø—Ä–æ—Å–∞
            if request.content_length and request.content_length > 10 * 1024 * 1024:  # 10MB
                return jsonify({'error': 'Request too large'}), 413

        @app.after_request
        def security_headers_middleware(response):
            """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
            response.headers['X-Content-Type-Options'] = 'nosniff'
            response.headers['X-Frame-Options'] = 'DENY'
            response.headers['X-XSS-Protection'] = '1; mode=block'
            response.headers['Referrer-Policy'] = 'strict-origin-when-cross-origin'

            # CSP
            csp = (
                "default-src 'self'; "
                "script-src 'self' 'unsafe-inline' https://telegram.org; "
                "style-src 'self' 'unsafe-inline'; "
                "img-src 'self' data: https:; "
                "connect-src 'self' https://api.telegram.org; "
                "frame-ancestors 'none'"
            )
            response.headers['Content-Security-Policy'] = csp

            return response

    except ImportError as e:
        print(f"‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –°–µ—Ä–≤–∏—Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: {e}")


def register_routes(app: Flask):
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤"""
    logger = logging.getLogger(__name__)



def register_error_handlers(app: Flask):
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –æ—à–∏–±–æ–∫"""
    from flask import jsonify, request, render_template_string

    @app.errorhandler(404)
    def not_found(error):
        if request.path.startswith('/api/'):
            return jsonify({'error': 'Endpoint –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404

        return render_template_string('''
        <!DOCTYPE html>
        <html>
        <head>
            <title>–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</title>
            <meta charset="UTF-8">
            <style>
                body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
                .error-container { max-width: 600px; margin: 0 auto; }
                .btn { padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 5px; }
            </style>
        </head>
        <body>
            <div class="error-container">
                <h1>üö´ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</h1>
                <p>–ó–∞–ø—Ä–æ—à–µ–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: <code>{{ request.path }}</code></p>
                <p>–í–æ–∑–º–æ–∂–Ω–æ, —Å—Å—ã–ª–∫–∞ —É—Å—Ç–∞—Ä–µ–ª–∞ –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—à–∏–±–∫—É.</p>
                <a href="/" class="btn">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
            </div>
        </body>
        </html>
        '''), 404

    @app.errorhandler(500)
    def internal_error(error):
        logging.getLogger(__name__).error(f"500 Error: {error}")
        if request.path.startswith('/api/'):
            return jsonify({'error': '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'}), 500
        return jsonify({'error': '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'}), 500

    @app.errorhandler(429)
    def rate_limit_handler(error):
        return jsonify({'error': '–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤', 'retry_after': 3600}), 429


def initialize_systems(app: Flask):
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–∏—Å—Ç–µ–º"""
    logger = logging.getLogger(__name__)

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram —Å–µ—Ä–≤–∏—Å–∞
    try:
        from app.config.settings import Config
        if Config.BOT_TOKEN:
            try:
                from app.services.telegram_service import create_telegram_service
                telegram_service = create_telegram_service(Config.BOT_TOKEN)
                if telegram_service:
                    app.telegram_service = telegram_service
                    logger.info("‚úÖ Telegram —Å–µ—Ä–≤–∏—Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
                else:
                    logger.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å Telegram —Å–µ—Ä–≤–∏—Å")
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram —Å–µ—Ä–≤–∏—Å–∞: {e}")
    except ImportError:
        logger.warning("‚ö†Ô∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è Telegram —Å–µ—Ä–≤–∏—Å–∞")

    # –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è
    @app.route('/health')
    def health_check():
        from flask import jsonify
        import os

        try:
            from app.config.settings import Config
            db_path = Config.DATABASE_PATH
            bot_token = bool(Config.BOT_TOKEN)
        except:
            db_path = 'telegram_mini_app.db'
            bot_token = bool(os.environ.get('BOT_TOKEN'))

        return jsonify({
            'status': 'healthy',
            'architecture': 'modular',
            'database_exists': os.path.exists(db_path),
            'bot_token_configured': bot_token,
            'modules_loaded': True
        })

    logger.info("‚úÖ –°–∏—Å—Ç–µ–º—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã")


# –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
app = None


def get_app():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
    global app
    if app is None:
        app = create_app()
    return app
{% extends "base.html" %}

{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ - Telegram Mini App{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ - Telegram Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/1.30.1/date_fns.min.js"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #f093fb;
            --success-color: #4facfe;
            --warning-color: #ff9a56;
            --danger-color: #ff6b6b;
            
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --text-muted: #a0aec0;
            --bg-primary: #ffffff;
            --bg-secondary: #f7fafc;
            --bg-tertiary: #edf2f7;
            --border-color: #e2e8f0;
            
            --border-radius: 16px;
            --border-radius-sm: 8px;
            --border-radius-lg: 24px;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.16);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .analytics-header {
            background: var(--primary-gradient);
            color: white;
            padding: 32px 24px;
            border-radius: var(--border-radius-lg);
            margin-bottom: 32px;
            box-shadow: var(--shadow-lg);
        }

        .analytics-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .analytics-header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Time Range Selector */
        .time-range-selector {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        .time-range-btn {
            padding: 8px 16px;
            border: 2px solid var(--border-color);
            background: white;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
        }

        .time-range-btn.active {
            background: var(--primary-gradient);
            color: white;
            border-color: transparent;
        }

        .time-range-btn:hover {
            border-color: var(--primary-color);
        }

        /* KPI Cards Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .kpi-card {
            background: white;
            padding: 24px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
        }

        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .kpi-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--border-radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: var(--bg-tertiary);
        }

        .kpi-trend {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .kpi-trend.positive {
            color: var(--success-color);
        }

        .kpi-trend.negative {
            color: var(--danger-color);
        }

        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .kpi-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .kpi-description {
            color: var(--text-muted);
            font-size: 0.75rem;
            margin-top: 8px;
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        .chart-card {
            background: white;
            padding: 24px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
        }

        .chart-header {
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .chart-subtitle {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Performance Table */
        .performance-section {
            background: white;
            padding: 24px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            margin-bottom: 32px;
        }

        .performance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .performance-table th,
        .performance-table td {
            text-align: left;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .performance-table th {
            background: var(--bg-tertiary);
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .performance-table tr:hover {
            background: var(--bg-secondary);
        }

        /* AI Recommendations */
        .recommendations-section {
            background: white;
            padding: 24px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            margin-bottom: 32px;
        }

        .recommendation-item {
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--border-radius-sm);
            margin-bottom: 12px;
            border-left: 4px solid var(--primary-color);
        }

        .recommendation-type {
            font-size: 0.75rem;
            color: var(--primary-color);
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .recommendation-text {
            color: var(--text-primary);
            font-weight: 500;
            margin-bottom: 4px;
        }

        .recommendation-impact {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .loading::before {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            .analytics-header {
                padding: 24px 20px;
            }

            .analytics-header h1 {
                font-size: 2rem;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .kpi-grid {
                grid-template-columns: 1fr;
            }

            .time-range-selector {
                flex-direction: column;
                align-items: stretch;
            }

            .performance-table {
                font-size: 0.875rem;
            }

            .performance-table th,
            .performance-table td {
                padding: 8px 12px;
            }
        }

        /* Animation Classes */
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-up {
            animation: slideUp 0.4s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="analytics-header fade-in">
            <h1>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h1>
            <p>–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤–∞—à–∏–º –∫–∞–Ω–∞–ª–∞–º –∏ —Ä–µ–∫–ª–∞–º–Ω—ã–º —Ä–∞–∑–º–µ—â–µ–Ω–∏—è–º</p>
        </div>

        <!-- Time Range Selector -->
        <div class="time-range-selector slide-up">
            <span style="font-weight: 600; color: var(--text-secondary);">–ü–µ—Ä–∏–æ–¥:</span>
            <button class="time-range-btn" data-range="7d">7 –¥–Ω–µ–π</button>
            <button class="time-range-btn active" data-range="30d">30 –¥–Ω–µ–π</button>
            <button class="time-range-btn" data-range="90d">3 –º–µ—Å—è—Ü–∞</button>
            <button class="time-range-btn" data-range="1y">–ì–æ–¥</button>
            <button class="time-range-btn" data-range="all">–í—Å–µ –≤—Ä–µ–º—è</button>
        </div>

        <!-- KPI Cards -->
        <div class="kpi-grid">
            <div class="kpi-card slide-up" style="animation-delay: 0.1s;">
                <div class="kpi-header">
                    <div class="kpi-icon" style="background: rgba(102, 126, 234, 0.1); color: var(--primary-color);">
                        üìà
                    </div>
                    <div class="kpi-trend positive">
                        <span>‚Üó</span>
                        <span id="revenue-trend">+12.5%</span>
                    </div>
                </div>
                <div class="kpi-value" id="total-revenue">‚ÇΩ 0</div>
                <div class="kpi-label">–û–±—â–∏–π –¥–æ—Ö–æ–¥</div>
                <div class="kpi-description">–û—Ç –≤—Å–µ—Ö —Ä–∞–∑–º–µ—â–µ–Ω–∏–π</div>
            </div>

            <div class="kpi-card slide-up" style="animation-delay: 0.2s;">
                <div class="kpi-header">
                    <div class="kpi-icon" style="background: rgba(79, 172, 254, 0.1); color: var(--success-color);">
                        üë•
                    </div>
                    <div class="kpi-trend positive">
                        <span>‚Üó</span>
                        <span id="audience-trend">+8.3%</span>
                    </div>
                </div>
                <div class="kpi-value" id="total-audience">0</div>
                <div class="kpi-label">–û–±—â–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è</div>
                <div class="kpi-description">–ü–æ–¥–ø–∏—Å—á–∏–∫–∏ –≤—Å–µ—Ö –∫–∞–Ω–∞–ª–æ–≤</div>
            </div>

            <div class="kpi-card slide-up" style="animation-delay: 0.3s;">
                <div class="kpi-header">
                    <div class="kpi-icon" style="background: rgba(240, 147, 251, 0.1); color: var(--accent-color);">
                        üéØ
                    </div>
                    <div class="kpi-trend positive">
                        <span>‚Üó</span>
                        <span id="conversion-trend">+15.2%</span>
                    </div>
                </div>
                <div class="kpi-value" id="conversion-rate">0%</div>
                <div class="kpi-label">–ö–æ–Ω–≤–µ—Ä—Å–∏—è</div>
                <div class="kpi-description">–ü—Ä–∏–Ω—è—Ç—ã–µ –æ—Ç–∫–ª–∏–∫–∏ / –í—Å–µ–≥–æ –æ—Ñ—Ñ–µ—Ä–æ–≤</div>
            </div>

            <div class="kpi-card slide-up" style="animation-delay: 0.4s;">
                <div class="kpi-header">
                    <div class="kpi-icon" style="background: rgba(255, 154, 86, 0.1); color: var(--warning-color);">
                        ‚ö°
                    </div>
                    <div class="kpi-trend negative">
                        <span>‚Üò</span>
                        <span id="response-trend">-2.1%</span>
                    </div>
                </div>
                <div class="kpi-value" id="avg-response-time">0—á</div>
                <div class="kpi-label">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞</div>
                <div class="kpi-description">–ù–∞ –Ω–æ–≤—ã–µ –æ—Ñ—Ñ–µ—Ä—ã</div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-card slide-up" style="animation-delay: 0.5s;">
                <div class="chart-header">
                    <div class="chart-title">–î–∏–Ω–∞–º–∏–∫–∞ –¥–æ—Ö–æ–¥–æ–≤</div>
                    <div class="chart-subtitle">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è –æ—Ç —Ä–∞–∑–º–µ—â–µ–Ω–∏–π</div>
                </div>
                <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>

            <div class="chart-card slide-up" style="animation-delay: 0.6s;">
                <div class="chart-header">
                    <div class="chart-title">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞–Ω–∞–ª–∞–º</div>
                    <div class="chart-subtitle">–î–æ–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–∞–ª–∞ –≤ –¥–æ—Ö–æ–¥–∞—Ö</div>
                </div>
                <div class="chart-container">
                    <canvas id="channelsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Performance Table -->
        <div class="performance-section slide-up" style="animation-delay: 0.7s;">
            <div class="chart-header">
                <div class="chart-title">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–∞–Ω–∞–ª–æ–≤</div>
                <div class="chart-subtitle">–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞–∂–¥–æ–º—É –∫–∞–Ω–∞–ª—É</div>
            </div>
            <table class="performance-table" id="performanceTable">
                <thead>
                    <tr>
                        <th>–ö–∞–Ω–∞–ª</th>
                        <th>–ü–æ–¥–ø–∏—Å—á–∏–∫–∏</th>
                        <th>–û—Ñ—Ñ–µ—Ä—ã</th>
                        <th>–î–æ—Ö–æ–¥</th>
                        <th>CTR</th>
                        <th>–ö–æ–Ω–≤–µ—Ä—Å–∏—è</th>
                        <th>–†–µ–π—Ç–∏–Ω–≥</th>
                    </tr>
                </thead>
                <tbody id="performanceTableBody">
                    <tr>
                        <td colspan="7" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- AI Recommendations -->
        <div class="recommendations-section slide-up" style="animation-delay: 0.8s;">
            <div class="chart-header">
                <div class="chart-title">ü§ñ AI-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</div>
                <div class="chart-subtitle">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</div>
            </div>
            <div id="recommendationsContainer">
                <div class="loading">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π...</div>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentTimeRange = '30d';
        let analyticsData = {};
        let revenueChart = null;
        let channelsChart = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeAnalytics();
            setupTimeRangeSelector();
            setupCharts();
            await loadAnalyticsData();
        });

        async function initializeAnalytics() {
            console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏...');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
            const authResult = await checkAuth();
            if (!authResult.success) {
                showError('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
                return;
            }

            console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', authResult.telegram_user_id);
        }

        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/check');
                return await response.json();
            } catch (error) {
                console.error('Auth check error:', error);
                return { success: false };
            }
        }

        function setupTimeRangeSelector() {
            const buttons = document.querySelectorAll('.time-range-btn');
            buttons.forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
                    buttons.forEach(b => b.classList.remove('active'));
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –Ω–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–µ
                    e.target.classList.add('active');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –ø–µ—Ä–∏–æ–¥
                    currentTimeRange = e.target.dataset.range;
                    
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                    await loadAnalyticsData();
                });
            });
        }

        function setupCharts() {
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞ –¥–æ—Ö–æ–¥–æ–≤
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            revenueChart = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '–î–æ—Ö–æ–¥—ã',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#f1f5f9'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '‚ÇΩ' + value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞ –∫–∞–Ω–∞–ª–æ–≤
            const channelsCtx = document.getElementById('channelsChart').getContext('2d');
            channelsChart = new Chart(channelsCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#667eea',
                            '#f093fb',
                            '#4facfe',
                            '#ff9a56',
                            '#ff6b6b',
                            '#51cf66'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        async function loadAnalyticsData() {
            try {
                showLoadingState(true);

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
                const metricsResponse = await fetch(`/api/analytics/metrics?range=${currentTimeRange}`);
                const metricsData = await metricsResponse.json();

                if (metricsData.success) {
                    updateKPICards(metricsData.metrics);
                } else {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ
                    updateKPICards({
                        total_revenue: 45230,
                        revenue_trend: 12.5,
                        total_audience: 125400,
                        audience_trend: 8.3,
                        conversion_rate: 24.6,
                        conversion_trend: 15.2,
                        avg_response_time: 3.2,
                        response_trend: -2.1
                    });
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
                const chartResponse = await fetch(`/api/analytics/charts?range=${currentTimeRange}`);
                const chartData = await chartResponse.json();

                if (chartData.success) {
                    updateCharts(chartData);
                } else {
                    updateChartsWithDemoData();
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                const performanceResponse = await fetch(`/api/analytics/performance?range=${currentTimeRange}`);
                const performanceData = await performanceResponse.json();

                if (performanceData.success) {
                    updatePerformanceTable(performanceData.channels);
                } else {
                    updatePerformanceTableWithDemoData();
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º AI-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
                const recommendationsResponse = await fetch(`/api/analytics/recommendations?range=${currentTimeRange}`);
                const recommendationsData = await recommendationsResponse.json();

                if (recommendationsData.success) {
                    updateRecommendations(recommendationsData.recommendations);
                } else {
                    updateRecommendationsWithDemoData();
                }

            } catch (error) {
                console.error('Error loading analytics:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏—Ç–∏–∫–∏');
            } finally {
                showLoadingState(false);
            }
        }

        function updateKPICards(metrics) {
            document.getElementById('total-revenue').textContent = 
                '‚ÇΩ ' + (metrics.total_revenue || 0).toLocaleString();
            document.getElementById('revenue-trend').textContent = 
                (metrics.revenue_trend > 0 ? '+' : '') + (metrics.revenue_trend || 0).toFixed(1) + '%';

            document.getElementById('total-audience').textContent = 
                (metrics.total_audience || 0).toLocaleString();
            document.getElementById('audience-trend').textContent = 
                (metrics.audience_trend > 0 ? '+' : '') + (metrics.audience_trend || 0).toFixed(1) + '%';

            document.getElementById('conversion-rate').textContent = 
                (metrics.conversion_rate || 0).toFixed(1) + '%';
            document.getElementById('conversion-trend').textContent = 
                (metrics.conversion_trend > 0 ? '+' : '') + (metrics.conversion_trend || 0).toFixed(1) + '%';

            document.getElementById('avg-response-time').textContent = 
                (metrics.avg_response_time || 0).toFixed(1) + '—á';
            document.getElementById('response-trend').textContent = 
                (metrics.response_trend > 0 ? '+' : '') + (metrics.response_trend || 0).toFixed(1) + '%';
        }

        function updateCharts(data) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –¥–æ—Ö–æ–¥–æ–≤
            if (data.revenue_chart) {
                revenueChart.data.labels = data.revenue_chart.labels;
                revenueChart.data.datasets[0].data = data.revenue_chart.data;
                revenueChart.update();
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –∫–∞–Ω–∞–ª–æ–≤
            if (data.channels_chart) {
                channelsChart.data.labels = data.channels_chart.labels;
                channelsChart.data.datasets[0].data = data.channels_chart.data;
                channelsChart.update();
            }
        }

        function updateChartsWithDemoData() {
            // –î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –¥–æ—Ö–æ–¥–æ–≤
            const days = [];
            const revenues = [];
            const now = new Date();
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                days.push(date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' }));
                revenues.push(Math.random() * 3000 + 1000);
            }

            revenueChart.data.labels = days;
            revenueChart.data.datasets[0].data = revenues;
            revenueChart.update();

            // –î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –∫–∞–Ω–∞–ª–æ–≤
            channelsChart.data.labels = ['Tech Channel', 'News Hub', 'Lifestyle', 'Business', 'Gaming'];
            channelsChart.data.datasets[0].data = [35, 25, 20, 15, 5];
            channelsChart.update();
        }

        function updatePerformanceTable(channels) {
            const tbody = document.getElementById('performanceTableBody');
            
            if (!channels || channels.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-muted); padding: 40px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
                return;
            }

            tbody.innerHTML = channels.map(channel => `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 8px; height: 8px; border-radius: 50%; background: ${channel.is_active ? '#4facfe' : '#a0aec0'};"></div>
                            <strong>@${channel.username}</strong>
                        </div>
                    </td>
                    <td>${(channel.subscriber_count || 0).toLocaleString()}</td>
                    <td>${channel.offers_count || 0}</td>
                    <td>‚ÇΩ${(channel.revenue || 0).toLocaleString()}</td>
                    <td>${(channel.ctr || 0).toFixed(1)}%</td>
                    <td>${(channel.conversion || 0).toFixed(1)}%</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <span>${'‚≠ê'.repeat(Math.round(channel.rating || 4))}</span>
                            <span style="color: var(--text-muted);">${(channel.rating || 4.0).toFixed(1)}</span>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function updatePerformanceTableWithDemoData() {
            const demoChannels = [
                {
                    username: 'tech_news_daily',
                    subscriber_count: 45200,
                    offers_count: 12,
                    revenue: 18500,
                    ctr: 3.2,
                    conversion: 24.5,
                    rating: 4.8,
                    is_active: true
                },
                {
                    username: 'business_insights',
                    subscriber_count: 28900,
                    offers_count: 8,
                    revenue: 12300,
                    ctr: 2.8,
                    conversion: 18.7,
                    rating: 4.6,
                    is_active: true
                },
                {
                    username: 'lifestyle_trends',
                    subscriber_count: 51300,
                    offers_count: 15,
                    revenue: 14200,
                    ctr: 4.1,
                    conversion: 21.3,
                    rating: 4.5,
                    is_active: false
                }
            ];

            updatePerformanceTable(demoChannels);
        }

        function updateRecommendations(recommendations) {
            const container = document.getElementById('recommendationsContainer');
            
            if (!recommendations || recommendations.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 40px;">–ù–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</div>';
                return;
            }

            container.innerHTML = recommendations.map(rec => `
                <div class="recommendation-item">
                    <div class="recommendation-type">${rec.type}</div>
                    <div class="recommendation-text">${rec.text}</div>
                    <div class="recommendation-impact">–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç: ${rec.impact}</div>
                </div>
            `).join('');
        }

        function updateRecommendationsWithDemoData() {
            const demoRecommendations = [
                {
                    type: '–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ü–µ–Ω',
                    text: '–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ü–µ–Ω—ã –∑–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –≤ –∫–∞–Ω–∞–ª–µ @tech_news_daily –Ω–∞ 15%',
                    impact: '–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –¥–æ—Ö–æ–¥–∞ –Ω–∞ ‚ÇΩ2,700 –≤ –º–µ—Å—è—Ü'
                },
                {
                    type: '–£–ª—É—á—à–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞',
                    text: '–î–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –≤ –∫–∞–Ω–∞–ª @lifestyle_trends',
                    impact: '–†–æ—Å—Ç –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–∞ 23%'
                },
                {
                    type: '–í—Ä–µ–º—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏',
                    text: '–û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏–π: 10:00-12:00 –∏ 18:00-20:00',
                    impact: '–£–≤–µ–ª–∏—á–µ–Ω–∏–µ CTR –Ω–∞ 18%'
                },
                {
                    type: '–ù–æ–≤—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏',
                    text: '–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–≤ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–§–∏–Ω–∞–Ω—Å—ã" –∏ "–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ"',
                    impact: '–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –Ω–∞ 35,000 –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤'
                }
            ];

            updateRecommendations(demoRecommendations);
        }

        function showLoadingState(isLoading) {
            const loadingElements = document.querySelectorAll('.loading');
            loadingElements.forEach(el => {
                el.style.display = isLoading ? 'flex' : 'none';
            });
        }

        function showError(message) {
            console.error('Analytics error:', message);
            // –í –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å toast-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        }

        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
        setInterval(loadAnalyticsData, 300000);
    </script>
</body>
</html>
{% endblock %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏ - Telegram Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/variables.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/channels.css') }}">
    
    <!-- –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/offers_management.css') }}">
    
    <style>
        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π */
        .proposal-card {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }
        
        .proposal-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .proposal-card.urgent {
            border-left: 4px solid var(--danger-color);
        }
        
        .proposal-card.new {
            border-left: 4px solid var(--primary-color);
        }
        
        .proposal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            gap: 16px;
        }
        
        .proposal-title {
            flex: 1;
        }
        
        .proposal-title h3 {
            margin: 0 0 4px 0;
            color: var(--text-primary);
            font-size: 18px;
        }
        
        .proposal-channel {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .proposal-budget {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 8px;
        }
        
        .proposal-deadline {
            font-size: 12px;
            color: var(--danger-color);
            font-weight: 500;
        }
        
        .proposal-deadline.warning {
            color: var(--warning-color);
        }
        
        .proposal-deadline.safe {
            color: var(--success-color);
        }
        
        .proposal-content {
            margin-bottom: 16px;
        }
        
        .proposal-description {
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 12px;
        }
        
        .proposal-requirements {
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: var(--border-radius-sm);
            margin-bottom: 12px;
        }
        
        .proposal-requirements h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: var(--text-primary);
        }
        
        .proposal-requirements ul {
            margin: 0;
            padding-left: 20px;
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .proposal-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .proposal-actions .btn {
            flex: 1;
            min-width: 120px;
        }
        
        .proposal-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .earnings-estimate {
            background: var(--success-color);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .quick-actions {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 100;
        }
        
        .quick-action-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            font-size: 20px;
            cursor: pointer;
            box-shadow: var(--shadow-md);
            transition: var(--transition);
        }
        
        .quick-action-btn:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-lg);
        }
        
        .filters-panel {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            align-items: end;
        }
        
        .placement-form {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .placement-form h3 {
            margin-bottom: 16px;
            color: var(--text-primary);
        }
        
        .form-row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        @media (max-width: 768px) {
            .proposal-actions {
                flex-direction: column;
            }
            
            .proposal-actions .btn {
                width: 100%;
                min-width: auto;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .quick-actions {
                bottom: 10px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Hero Section -->
        <div class="hero-section">
            <button class="back-btn" onclick="goBack()">‚Üê –ù–∞–∑–∞–¥</button>
            <div class="hero-content">
                <span class="hero-icon">üì•</span>
                <h1 class="hero-title">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏</h1>
                <p class="hero-subtitle">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –≤—Ö–æ–¥—è—â–∏–º–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏ —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª–µ–π</p>
            </div>
        </div>

        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ç–∞–±–∞–º -->
        <div class="navigation-grid">
            <div class="nav-card active" data-tab="incoming" onclick="switchTab('incoming')">
                <div class="nav-icon">üì•</div>
                <div class="nav-content">
                    <h3>–í—Ö–æ–¥—è—â–∏–µ</h3>
                    <p>–ù–æ–≤—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</p>
                </div>
            </div>
            <div class="nav-card" data-tab="active" onclick="switchTab('active')">
                <div class="nav-icon">‚ö°</div>
                <div class="nav-content">
                    <h3>–ê–∫—Ç–∏–≤–Ω—ã–µ</h3>
                    <p>–ü—Ä–∏–Ω—è—Ç—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</p>
                </div>
            </div>
            <div class="nav-card" data-tab="history" onclick="switchTab('history')">
                <div class="nav-icon">üìã</div>
                <div class="nav-content">
                    <h3>–ò—Å—Ç–æ—Ä–∏—è</h3>
                    <p>–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏</p>
                </div>
            </div>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ "–í—Ö–æ–¥—è—â–∏–µ" -->
        <div class="tab-content active" data-tab="incoming">
            <!-- –§–∏–ª—å—Ç—Ä—ã -->
            <div class="filters-panel">
                <div class="filters-grid">
                    <div class="filter-group">
                        <label>–ö–∞–Ω–∞–ª:</label>
                        <select class="form-select" id="channel-filter">
                            <option value="">–í—Å–µ –∫–∞–Ω–∞–ª—ã</option>
                            <!-- –ö–∞–Ω–∞–ª—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>–ë—é–¥–∂–µ—Ç –æ—Ç:</label>
                        <input type="number" class="form-input" placeholder="0" id="budget-min">
                    </div>
                    
                    <div class="filter-group">
                        <label>–°—Ä–æ–∫ –∏—Å—Ç–µ—á–µ–Ω–∏—è:</label>
                        <select class="form-select" id="deadline-filter">
                            <option value="">–í—Å–µ</option>
                            <option value="urgent">–°—Ä–æ—á–Ω—ã–µ (< 24—á)</option>
                            <option value="soon">–°–∫–æ—Ä–æ (< 3 –¥–Ω—è)</option>
                            <option value="normal">–û–±—ã—á–Ω—ã–µ (> 3 –¥–Ω—è)</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <button class="btn btn-primary" onclick="applyFilters()">
                            üîç –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π -->
            <div id="incoming-proposals">
                <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è -->
                <div class="loading-content">
                    <div class="loading-spinner"></div>
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π...</p>
                </div>
            </div>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ "–ê–∫—Ç–∏–≤–Ω—ã–µ" -->
        <div class="tab-content" data-tab="active">
            <div id="active-proposals">
                <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è -->
            </div>
            
            <!-- –§–æ—Ä–º–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è -->
            <div class="placement-form" id="placement-form" style="display: none;">
                <h3>üì§ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ—Å—Ç <span class="required">*</span></label>
                        <input type="url" class="form-input" id="post-url" 
                               placeholder="https://t.me/channel/123456">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                        <textarea class="form-textarea" id="placement-notes" 
                                  placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ –æ —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏"></textarea>
                    </div>
                </div>
                <div class="form-row">
                    <button class="btn btn-primary" onclick="submitPlacement()">
                        ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ
                    </button>
                    <button class="btn btn-secondary" onclick="cancelPlacement()">
                        ‚ùå –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
            </div>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ "–ò—Å—Ç–æ—Ä–∏—è" -->
        <div class="tab-content" data-tab="history">
            <div id="history-proposals">
                <!-- –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π -->
            </div>
        </div>
    </div>

    <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
    <div class="quick-actions">
        <button class="quick-action-btn" onclick="refreshProposals()" title="–û–±–Ω–æ–≤–∏—Ç—å">
            üîÑ
        </button>
        <button class="quick-action-btn" onclick="showNotifications()" title="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è">
            üîî
        </button>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∫—Ä–∏–ø—Ç—ã -->
    <script src="{{ url_for('static', filename='js/telegram-app.js') }}"></script>
    <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
    
    <script>
        class ChannelProposalsManager {
            constructor() {
                this.currentTab = 'incoming';
                this.proposals = [];
                this.channels = [];
                this.currentProposal = null;
                this.init();
            }

            init() {
                this.loadChannels();
                this.loadProposals();
                this.setupEventListeners();
            }

            setupEventListeners() {
                document.addEventListener('click', (e) => {
                    if (e.target.matches('.btn-accept-proposal')) {
                        this.acceptProposal(e.target.dataset.proposalId);
                    }
                    if (e.target.matches('.btn-reject-proposal')) {
                        this.showRejectModal(e.target.dataset.proposalId);
                    }
                    if (e.target.matches('.btn-view-details')) {
                        this.showProposalDetails(e.target.dataset.proposalId);
                    }
                    if (e.target.matches('.btn-submit-placement')) {
                        this.showPlacementForm(e.target.dataset.proposalId);
                    }
                });
            }

            async loadChannels() {
                try {
                    const response = await fetch('/api/channels/my');
                    const data = await response.json();
                    
                    if (data.success) {
                        this.channels = data.channels;
                        this.updateChannelFilter();
                    }
                } catch (error) {
                    console.error('Error loading channels:', error);
                }
            }

            async loadProposals() {
                try {
                    const response = await fetch('/api/proposals/incoming');
                    const data = await response.json();
                    
                    if (data.success) {
                        this.proposals = data.proposals;
                        this.renderProposals();
                    } else {
                        this.showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π');
                    }
                } catch (error) {
                    console.error('Error loading proposals:', error);
                    this.showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π');
                }
            }

            updateChannelFilter() {
                const select = document.getElementById('channel-filter');
                select.innerHTML = '<option value="">–í—Å–µ –∫–∞–Ω–∞–ª—ã</option>';
                
                this.channels.forEach(channel => {
                    const option = document.createElement('option');
                    option.value = channel.id;
                    option.textContent = channel.title;
                    select.appendChild(option);
                });
            }

            renderProposals() {
                const container = document.getElementById('incoming-proposals');
                
                const incomingProposals = this.proposals.filter(p => p.status === 'sent');
                
                if (incomingProposals.length === 0) {
                    container.innerHTML = this.getEmptyStateHTML();
                    return;
                }

                container.innerHTML = incomingProposals.map(proposal => 
                    this.getProposalCardHTML(proposal)
                ).join('');
            }

            getEmptyStateHTML() {
                return `
                    <div class="empty-state">
                        <span class="stat-icon">üì•</span>
                        <h3>–ù–µ—Ç –Ω–æ–≤—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</h3>
                        <p>–ù–æ–≤—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏ —Ä–µ–∫–ª–∞–º—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</p>
                    </div>
                `;
            }

            getProposalCardHTML(proposal) {
                const urgencyClass = this.getUrgencyClass(proposal.expires_at);
                const timeLeft = this.getTimeLeft(proposal.expires_at);
                const estimatedEarnings = this.calculateEarnings(proposal);
                
                return `
                    <div class="proposal-card ${urgencyClass}" data-proposal-id="${proposal.id}">
                        <div class="proposal-header">
                            <div class="proposal-title">
                                <h3>${proposal.offer_title}</h3>
                                <div class="proposal-channel">üì¢ ${proposal.channel_title}</div>
                                <div class="proposal-budget">üí∞ ${proposal.offer_budget} ‚ÇΩ</div>
                                <div class="proposal-deadline ${this.getDeadlineClass(proposal.expires_at)}">
                                    ‚è∞ ${timeLeft}
                                </div>
                            </div>
                            <div class="proposal-status">
                                <span class="proposal-status sent">–ù–æ–≤–æ–µ</span>
                            </div>
                        </div>
                        
                        <div class="proposal-content">
                            <div class="proposal-description">
                                ${proposal.offer_description || '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ'}
                            </div>
                            
                            ${proposal.placement_requirements ? `
                                <div class="proposal-requirements">
                                    <h4>üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ä–∞–∑–º–µ—â–µ–Ω–∏—é:</h4>
                                    <div>${proposal.placement_requirements}</div>
                                </div>
                            ` : ''}
                            
                            <div class="proposal-stats">
                                <span class="stat-item">üéØ ${proposal.target_audience || '–õ—é–±–∞—è'}</span>
                                <span class="stat-item">üìÖ ${proposal.expected_placement_duration || 7} –¥–Ω–µ–π</span>
                                <span class="stat-item">üë• ${this.formatNumber(proposal.subscriber_count)} –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤</span>
                            </div>
                        </div>
                        
                        <div class="proposal-actions">
                            <button class="btn btn-primary btn-accept-proposal" 
                                    data-proposal-id="${proposal.id}">
                                ‚úÖ –ü—Ä–∏–Ω—è—Ç—å
                            </button>
                            <button class="btn btn-secondary btn-reject-proposal" 
                                    data-proposal-id="${proposal.id}">
                                ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                            </button>
                            <button class="btn btn-secondary btn-view-details" 
                                    data-proposal-id="${proposal.id}">
                                üìã –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                            </button>
                        </div>
                        
                        <div class="proposal-meta">
                            <span>üìÖ ${this.formatDate(proposal.created_at)}</span>
                            <span class="earnings-estimate">~${estimatedEarnings} ‚ÇΩ</span>
                        </div>
                    </div>
                `;
            }

            async acceptProposal(proposalId) {
                try {
                    const response = await fetch(`/api/proposals/${proposalId}/accept`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();

                    if (data.success) {
                        this.showSuccess('–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ!');
                        this.loadProposals();
                    } else {
                        this.showError('–û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è');
                    }
                } catch (error) {
                    console.error('Error accepting proposal:', error);
                    this.showError('–û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è');
                }
            }

            showRejectModal(proposalId) {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</h2>
                            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è <span class="required">*</span></label>
                                <textarea class="form-textarea" id="rejection-reason" 
                                          placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">
                                –û—Ç–º–µ–Ω–∞
                            </button>
                            <button class="btn btn-primary" onclick="channelProposalsManager.rejectProposal(${proposalId})">
                                –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                setTimeout(() => modal.classList.add('active'), 10);
            }

            async rejectProposal(proposalId) {
                const reason = document.getElementById('rejection-reason').value.trim();
                
                if (!reason) {
                    this.showError('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è');
                    return;
                }

                try {
                    const response = await fetch(`/api/proposals/${proposalId}/reject`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ reason })
                    });

                    const data = await response.json();

                    if (data.success) {
                        this.showSuccess('–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ');
                        this.loadProposals();
                        document.querySelector('.modal-overlay').remove();
                    } else {
                        this.showError('–û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è');
                    }
                } catch (error) {
                    console.error('Error rejecting proposal:', error);
                    this.showError('–û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è');
                }
            }

            showPlacementForm(proposalId) {
                this.currentProposal = proposalId;
                document.getElementById('placement-form').style.display = 'block';
                document.getElementById('post-url').focus();
            }

            async submitPlacement() {
                const postUrl = document.getElementById('post-url').value.trim();
                const notes = document.getElementById('placement-notes').value.trim();

                if (!postUrl) {
                    this.showError('–£–∫–∞–∂–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –ø–æ—Å—Ç');
                    return;
                }

                try {
                    const response = await fetch(`/api/proposals/${this.currentProposal}/submit-placement`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            post_url: postUrl,
                            placement_notes: notes
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        this.showSuccess('–†–∞–∑–º–µ—â–µ–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ!');
                        this.cancelPlacement();
                        this.loadProposals();
                    } else {
                        this.showError('–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è');
                    }
                } catch (error) {
                    console.error('Error submitting placement:', error);
                    this.showError('–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è');
                }
            }

            cancelPlacement() {
                document.getElementById('placement-form').style.display = 'none';
                document.getElementById('post-url').value = '';
                document.getElementById('placement-notes').value = '';
                this.currentProposal = null;
            }

            // Utility methods
            getUrgencyClass(expiresAt) {
                const hoursLeft = this.getHoursLeft(expiresAt);
                if (hoursLeft < 24) return 'urgent';
                if (hoursLeft < 72) return 'new';
                return '';
            }

            getDeadlineClass(expiresAt) {
                const hoursLeft = this.getHoursLeft(expiresAt);
                if (hoursLeft < 24) return 'danger';
                if (hoursLeft < 72) return 'warning';
                return 'safe';
            }

            getHoursLeft(expiresAt) {
                const now = new Date();
                const expires = new Date(expiresAt);
                return Math.max(0, Math.floor((expires - now) / (1000 * 60 * 60)));
            }

            getTimeLeft(expiresAt) {
                const hoursLeft = this.getHoursLeft(expiresAt);
                if (hoursLeft < 1) return '–ò—Å—Ç–µ–∫–∞–µ—Ç';
                if (hoursLeft < 24) return `${hoursLeft} —á.`;
                const daysLeft = Math.floor(hoursLeft / 24);
                return `${daysLeft} –¥–Ω.`;
            }

            calculateEarnings(proposal) {
                return Math.min(
                    proposal.offer_budget * 0.8, // 80% –æ—Ç –±—é–¥–∂–µ—Ç–∞
                    proposal.subscriber_count * 0.01 // 1 –∫–æ–ø–µ–π–∫–∞ –∑–∞ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞
                );
            }

            formatNumber(num) {
                if (num >= 1000000) return Math.floor(num / 100000) / 10 + 'M';
                if (num >= 1000) return Math.floor(num / 100) / 10 + 'K';
                return num.toString();
            }

            formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            showSuccess(message) {
                this.showNotification(message, 'success');
            }

            showError(message) {
                this.showNotification(message, 'error');
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <span class="notification-icon">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
                    <span class="notification-message">${message}</span>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => notification.classList.add('show'), 10);
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        let channelProposalsManager;
        
        document.addEventListener('DOMContentLoaded', () => {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
            channelProposalsManager = new ChannelProposalsManager();
        });

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–∞–±–∞–º–∏
        function switchTab(tabName) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
            document.querySelectorAll('.nav-card').forEach(card => {
                card.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelector(`.tab-content[data-tab="${tabName}"]`).classList.add('active');
            
            channelProposalsManager.currentTab = tabName;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
            if (tabName === 'active') {
                loadActiveProposals();
            } else if (tabName === 'history') {
                loadHistoryProposals();
            }
        }

        function applyFilters() {
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
            channelProposalsManager.renderProposals();
        }

        function refreshProposals() {
            channelProposalsManager.loadProposals();
        }

        function showNotifications() {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            alert('–§—É–Ω–∫—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏');
        }

        function goBack() {
            window.history.back();
        }

        async function loadActiveProposals() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
            try {
                const response = await fetch('/api/proposals/incoming?status=accepted');
                const data = await response.json();
                
                if (data.success) {
                    const container = document.getElementById('active-proposals');
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
                    container.innerHTML = data.proposals.map(proposal => 
                        getActiveProposalHTML(proposal)
                    ).join('');
                }
            } catch (error) {
                console.error('Error loading active proposals:', error);
            }
        }

        async function loadHistoryProposals() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
            try {
                const response = await fetch('/api/proposals/incoming?status=completed');
                const data = await response.json();
                
                if (data.success) {
                    const container = document.getElementById('history-proposals');
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
                    container.innerHTML = data.proposals.map(proposal => 
                        getHistoryProposalHTML(proposal)
                    ).join('');
                }
            } catch (error) {
                console.error('Error loading history proposals:', error);
            }
        }

        function getActiveProposalHTML(proposal) {
            return `
                <div class="proposal-card">
                    <div class="proposal-header">
                        <div class="proposal-title">
                            <h3>${proposal.offer_title}</h3>
                            <div class="proposal-channel">üì¢ ${proposal.channel_title}</div>
                        </div>
                        <span class="proposal-status accepted">–ü—Ä–∏–Ω—è—Ç–æ</span>
                    </div>
                    <div class="proposal-actions">
                        <button class="btn btn-primary btn-submit-placement" 
                                data-proposal-id="${proposal.id}">
                            üì§ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ
                        </button>
                    </div>
                </div>
            `;
        }

        function getHistoryProposalHTML(proposal) {
            return `
                <div class="proposal-card">
                    <div class="proposal-header">
                        <div class="proposal-title">
                            <h3>${proposal.offer_title}</h3>
                            <div class="proposal-channel">üì¢ ${proposal.channel_title}</div>
                        </div>
                        <span class="proposal-status completed">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
                    </div>
                    <div class="proposal-meta">
                        <span>üëÅ ${proposal.final_views_count || 0} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</span>
                        <span>üí∞ ${proposal.earnings || 0} ‚ÇΩ</span>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
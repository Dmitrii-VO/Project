<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Статистика и аналитика - Telegram Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Существующие стили -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/variables.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/offers.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/offers_management.css') }}">
    
    <!-- Chart.js для графиков -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        /* Стили для дашборда статистики */
        .dashboard-header {
            background: var(--primary-gradient);
            color: white;
            padding: 24px;
            border-radius: var(--border-radius);
            margin-bottom: 24px;
            text-align: center;
        }
        
        .dashboard-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .dashboard-subtitle {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        
        .metric-card {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
        }
        
        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .metric-icon {
            font-size: 24px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 50%;
            color: var(--primary-color);
        }
        
        .metric-trend {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .metric-trend.positive {
            color: var(--success-color);
        }
        
        .metric-trend.negative {
            color: var(--danger-color);
        }
        
        .metric-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .metric-label {
            font-size: 14px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .metric-details {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }
        
        .metric-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
        }
        
        .metric-detail-label {
            color: var(--text-secondary);
        }
        
        .metric-detail-value {
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .charts-section {
            margin-bottom: 32px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
        }
        
        .chart-card {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .chart-filter {
            display: flex;
            gap: 8px;
        }
        
        .filter-btn {
            padding: 4px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .performance-table {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        
        .table-header {
            background: var(--bg-secondary);
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .table-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .table-content {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .performance-item {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            transition: var(--transition);
        }
        
        .performance-item:hover {
            background: var(--bg-secondary);
        }
        
        .performance-item:last-child {
            border-bottom: none;
        }
        
        .performance-rank {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            margin-right: 16px;
            flex-shrink: 0;
        }
        
        .performance-rank.gold {
            background: #ffd700;
            color: #000;
        }
        
        .performance-rank.silver {
            background: #c0c0c0;
            color: #000;
        }
        
        .performance-rank.bronze {
            background: #cd7f32;
            color: #fff;
        }
        
        .performance-info {
            flex: 1;
        }
        
        .performance-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .performance-details {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .performance-metrics {
            display: flex;
            gap: 16px;
            align-items: center;
        }
        
        .performance-metric {
            text-align: center;
            font-size: 12px;
        }
        
        .performance-metric-value {
            font-weight: 600;
            color: var(--text-primary);
            display: block;
        }
        
        .performance-metric-label {
            color: var(--text-secondary);
            margin-top: 2px;
        }
        
        .real-time-updates {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: 12px 16px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .real-time-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-color);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .export-panel {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 24px;
            text-align: center;
        }
        
        .export-buttons {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .date-range-selector {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: 16px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }
        
        .date-range-selector label {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .date-range-selector input {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-secondary);
        }
        
        .insights-panel {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 24px;
            border-left: 4px solid var(--primary-color);
        }
        
        .insights-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .insight-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .insight-icon {
            font-size: 16px;
            margin-top: 2px;
        }
        
        .insight-content {
            flex: 1;
        }
        
        .insight-text {
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        .insight-action {
            margin-top: 8px;
        }
        
        .insight-action .btn {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        @media (max-width: 768px) {
            .metrics-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .performance-metrics {
                flex-direction: column;
                gap: 8px;
            }
            
            .date-range-selector {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .export-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .real-time-updates {
                position: static;
                margin-bottom: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Заголовок дашборда -->
        <div class="dashboard-header">
            <div class="dashboard-title">📊 Статистика и аналитика</div>
            <div class="dashboard-subtitle">Подробная аналитика ваших рекламных кампаний</div>
        </div>

        <!-- Индикатор обновлений в реальном времени -->
        <div class="real-time-updates">
            <div class="real-time-indicator"></div>
            <span>Обновлено: <span id="last-update-time">--:--</span></span>
        </div>

        <!-- Селектор периода -->
        <div class="date-range-selector">
            <label>Период:</label>
            <input type="date" id="date-from" class="form-input">
            <span>—</span>
            <input type="date" id="date-to" class="form-input">
            <button class="btn btn-primary" onclick="updateDateRange()">Применить</button>
            <button class="btn btn-secondary" onclick="setQuickRange('week')">Неделя</button>
            <button class="btn btn-secondary" onclick="setQuickRange('month')">Месяц</button>
        </div>

        <!-- Основные метрики -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon">🎯</div>
                    <div class="metric-trend positive">
                        <span>↗</span> +12%
                    </div>
                </div>
                <div class="metric-value" id="total-offers">0</div>
                <div class="metric-label">Всего офферов</div>
                <div class="metric-details">
                    <div class="metric-detail-item">
                        <span class="metric-detail-label">Активных:</span>
                        <span class="metric-detail-value" id="active-offers">0</span>
                    </div>
                    <div class="metric-detail-item">
                        <span class="metric-detail-label">Завершенных:</span>
                        <span class="metric-detail-value" id="completed-offers">0</span>
                    </div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon">📤</div>
                    <div class="metric-trend positive">
                        <span>↗</span> +8%
                    </div>
                </div>
                <div class="metric-value" id="total-proposals">0</div>
                <div class="metric-label">Предложений отправлено</div>
                <div class="metric-details">
                    <div class="metric-detail-item">
                        <span class="metric-detail-label">Принято:</span>
                        <span class="metric-detail-value" id="accepted-proposals">0</span>
                    </div>
                    <div class="metric-detail-item">
                        <span class="metric-detail-label">Отклонено:</span>
                        <span class="metric-detail-value" id="rejected-proposals">0</span>
                    </div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon">👁</div>
                    <div class="metric-trend positive">
                        <span>↗</span> +23%
                    </div>
                </div>
                <div class="metric-value" id="total-views">0</div>
                <div class="metric-label">Всего просмотров</div>
                <div class="metric-details">
                    <div class="metric-detail-item">
                        <span class="metric-detail-label">Сегодня:</span>
                        <span class="metric-detail-value" id="today-views">0</span>
                    </div>
                    <div class="metric-detail-item">
                        <span class="metric-detail-label">Средний CPM:</span>
                        <span class="metric-detail-value" id="avg-cpm">0₽</span>
                    </div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon">💰</div>
                    <div class="metric-trend negative">
                        <span>↘</span> -5%
                    </div>
                </div>
                <div class="metric-value" id="total-spent">0₽</div>
                <div class="metric-label">Потрачено</div>
                <div class="metric-details">
                    <div class="metric-detail-item">
                        <span class="metric-detail-label">Этот месяц:</span>
                        <span class="metric-detail-value" id="month-spent">0₽</span>
                    </div>
                    <div class="metric-detail-item">
                        <span class="metric-detail-label">Средний чек:</span>
                        <span class="metric-detail-value" id="avg-check">0₽</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Графики -->
        <div class="charts-section">
            <h2 class="section-title">📈 Динамика показателей</h2>
            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">Просмотры по дням</div>
                        <div class="chart-filter">
                            <button class="filter-btn active" onclick="changeChartPeriod('views', '7d')">7д</button>
                            <button class="filter-btn" onclick="changeChartPeriod('views', '30d')">30д</button>
                            <button class="filter-btn" onclick="changeChartPeriod('views', '90d')">90д</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="viewsChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">Статусы предложений</div>
                        <div class="chart-filter">
                            <button class="filter-btn active" onclick="changeChartPeriod('proposals', 'all')">Все</button>
                            <button class="filter-btn" onclick="changeChartPeriod('proposals', 'month')">Месяц</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="proposalsChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">Расходы по периодам</div>
                        <div class="chart-filter">
                            <button class="filter-btn active" onclick="changeChartPeriod('spending', 'daily')">Дни</button>
                            <button class="filter-btn" onclick="changeChartPeriod('spending', 'weekly')">Недели</button>
                            <button class="filter-btn" onclick="changeChartPeriod('spending', 'monthly')">Месяцы</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="spendingChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">Эффективность каналов</div>
                        <div class="chart-filter">
                            <button class="filter-btn active" onclick="changeChartPeriod('efficiency', 'cpm')">CPM</button>
                            <button class="filter-btn" onclick="changeChartPeriod('efficiency', 'views')">Просмотры</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="efficiencyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Аналитические инсайты -->
        <div class="insights-panel">
            <div class="insights-title">
                <span>🔍</span> Аналитические инсайты
            </div>
            <div id="insights-content">
                <div class="insight-item">
                    <div class="insight-icon">📊</div>
                    <div class="insight-content">
                        <div class="insight-text">
                            Лучшее время для запуска кампаний: <strong>14:00-16:00</strong>. 
                            В это время коэффициент принятия на 23% выше среднего.
                        </div>
                        <div class="insight-action">
                            <button class="btn btn-primary">Запланировать кампанию</button>
                        </div>
                    </div>
                </div>
                
                <div class="insight-item">
                    <div class="insight-icon">🎯</div>
                    <div class="insight-content">
                        <div class="insight-text">
                            Каналы категории "Технологии" показывают лучший ROI - 
                            средний CPM на 15% ниже, чем у остальных категорий.
                        </div>
                        <div class="insight-action">
                            <button class="btn btn-primary">Найти tech-каналы</button>
                        </div>
                    </div>
                </div>
                
                <div class="insight-item">
                    <div class="insight-icon">⚡</div>
                    <div class="insight-content">
                        <div class="insight-text">
                            Рекомендуется увеличить бюджет кампании "#campaign_123" - 
                            она показывает отличные результаты с низким CPM.
                        </div>
                        <div class="insight-action">
                            <button class="btn btn-primary">Увеличить бюджет</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Топ каналы по эффективности -->
        <div class="performance-table">
            <div class="table-header">
                <div class="table-title">🏆 Топ каналы по эффективности</div>
            </div>
            <div class="table-content" id="top-channels">
                <!-- Содержимое будет загружено через JavaScript -->
            </div>
        </div>

        <!-- Экспорт данных -->
        <div class="export-panel">
            <h3>📋 Экспорт данных</h3>
            <div class="export-buttons">
                <button class="btn btn-secondary" onclick="exportData('csv')">
                    <span>📄</span> Экспорт в CSV
                </button>
                <button class="btn btn-secondary" onclick="exportData('excel')">
                    <span>📊</span> Экспорт в Excel
                </button>
                <button class="btn btn-secondary" onclick="exportData('pdf')">
                    <span>📑</span> Отчет в PDF
                </button>
                <button class="btn btn-primary" onclick="shareReport()">
                    <span>📤</span> Поделиться отчетом
                </button>
            </div>
        </div>
    </div>

    <!-- Подключаем скрипты -->
    <script src="{{ url_for('static', filename='js/telegram-app.js') }}"></script>
    <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
    
    <script>
        class StatisticsDashboard {
            constructor() {
                this.charts = {};
                this.data = {};
                this.updateInterval = null;
                this.init();
            }

            init() {
                this.loadDashboardData();
                this.initCharts();
                this.startRealTimeUpdates();
                this.setDefaultDateRange();
            }

            setDefaultDateRange() {
                const today = new Date();
                const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                
                document.getElementById('date-from').value = weekAgo.toISOString().split('T')[0];
                document.getElementById('date-to').value = today.toISOString().split('T')[0];
            }

            async loadDashboardData() {
                try {
                    const response = await fetch('/api/statistics/dashboard');
                    const data = await response.json();
                    
                    if (data.success) {
                        this.data = data;
                        this.updateMetrics();
                        this.updateCharts();
                        this.updateTopChannels();
                    }
                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                }
            }

            updateMetrics() {
                const metrics = [
                    { id: 'total-offers', value: this.data.offers?.total || 0 },
                    { id: 'active-offers', value: this.data.offers?.active || 0 },
                    { id: 'completed-offers', value: this.data.offers?.completed || 0 },
                    { id: 'total-proposals', value: this.data.proposals?.total || 0 },
                    { id: 'accepted-proposals', value: this.data.proposals?.accepted || 0 },
                    { id: 'rejected-proposals', value: this.data.proposals?.rejected || 0 },
                    { id: 'total-views', value: this.formatNumber(this.data.placements?.total_views || 0) },
                    { id: 'today-views', value: this.formatNumber(this.data.placements?.today_views || 0) },
                    { id: 'total-spent', value: this.formatCurrency(this.data.offers?.total_budget || 0) },
                    { id: 'month-spent', value: this.formatCurrency(this.data.offers?.month_spent || 0) },
                    { id: 'avg-cpm', value: this.formatCurrency(this.calculateCPM()) },
                    { id: 'avg-check', value: this.formatCurrency(this.calculateAvgCheck()) }
                ];

                metrics.forEach(metric => {
                    const element = document.getElementById(metric.id);
                    if (element) {
                        this.animateValue(element, metric.value);
                    }
                });
            }

            animateValue(element, newValue) {
                const currentValue = element.textContent;
                element.textContent = newValue;
                
                // Добавляем анимацию
                element.style.transform = 'scale(1.1)';
                element.style.transition = 'transform 0.3s ease';
                
                setTimeout(() => {
                    element.style.transform = 'scale(1)';
                }, 300);
            }

            initCharts() {
                // График просмотров
                const viewsCtx = document.getElementById('viewsChart').getContext('2d');
                this.charts.views = new Chart(viewsCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Просмотры',
                            data: [],
                            borderColor: 'rgb(102, 126, 234)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                // График предложений (пончик)
                const proposalsCtx = document.getElementById('proposalsChart').getContext('2d');
                this.charts.proposals = new Chart(proposalsCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Принято', 'Отклонено', 'Ожидает'],
                        datasets: [{
                            data: [0, 0, 0],
                            backgroundColor: [
                                'rgb(76, 175, 80)',
                                'rgb(244, 67, 54)',
                                'rgb(255, 193, 7)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });

                // График расходов
                const spendingCtx = document.getElementById('spendingChart').getContext('2d');
                this.charts.spending = new Chart(spendingCtx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Расходы',
                            data: [],
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: 'rgb(102, 126, 234)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                // График эффективности
                const efficiencyCtx = document.getElementById('efficiencyChart').getContext('2d');
                this.charts.efficiency = new Chart(efficiencyCtx, {
                    type: 'radar',
                    data: {
                        labels: ['CPM', 'CTR', 'Конверсия', 'ROI', 'Охват'],
                        datasets: [{
                            label: 'Эффективность',
                            data: [0, 0, 0, 0, 0],
                            borderColor: 'rgb(102, 126, 234)',
                            backgroundColor: 'rgba(102, 126, 234, 0.2)',
                            pointBackgroundColor: 'rgb(102, 126, 234)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgb(102, 126, 234)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
            }

            updateCharts() {
                // Обновляем данные графиков
                this.updateViewsChart();
                this.updateProposalsChart();
                this.updateSpendingChart();
                this.updateEfficiencyChart();
            }

            updateViewsChart() {
                const chart = this.charts.views;
                if (!chart) return;

                // Генерируем тестовые данные
                const labels = [];
                const data = [];
                
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    labels.push(date.toLocaleDateString('ru-RU', { month: 'short', day: 'numeric' }));
                    data.push(Math.floor(Math.random() * 1000) + 500);
                }

                chart.data.labels = labels;
                chart.data.datasets[0].data = data;
                chart.update();
            }

            updateProposalsChart() {
                const chart = this.charts.proposals;
                if (!chart) return;

                const accepted = this.data.proposals?.accepted || 0;
                const rejected = this.data.proposals?.rejected || 0;
                const pending = this.data.proposals?.pending || 0;

                chart.data.datasets[0].data = [accepted, rejected, pending];
                chart.update();
            }

            updateSpendingChart() {
                const chart = this.charts.spending;
                if (!chart) return;

                // Генерируем тестовые данные расходов
                const labels = [];
                const data = [];
                
                for (let i = 29; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    labels.push(date.toLocaleDateString('ru-RU', { day: 'numeric' }));
                    data.push(Math.floor(Math.random() * 5000) + 1000);
                }

                chart.data.labels = labels;
                chart.data.datasets[0].data = data;
                chart.update();
            }

            updateEfficiencyChart() {
                const chart = this.charts.efficiency;
                if (!chart) return;

                // Рассчитываем метрики эффективности
                const cpm = this.calculateCPM();
                const ctr = Math.random() * 5 + 1; // Примерные данные
                const conversion = Math.random() * 10 + 2;
                const roi = Math.random() * 150 + 50;
                const reach = Math.random() * 80 + 20;

                chart.data.datasets[0].data = [cpm, ctr, conversion, roi, reach];
                chart.update();
            }

            updateTopChannels() {
                const container = document.getElementById('top-channels');
                
                // Генерируем тестовые данные для топ каналов
                const channels = [
                    { name: 'TechNews Channel', subscribers: 125000, views: 45000, cpm: 0.8, rank: 1 },
                    { name: 'Business Today', subscribers: 89000, views: 32000, cpm: 1.2, rank: 2 },
                    { name: 'Crypto World', subscribers: 156000, views: 28000, cpm: 1.5, rank: 3 },
                    { name: 'Marketing Pro', subscribers: 67000, views: 22000, cpm: 1.8, rank: 4 },
                    { name: 'StartUp News', subscribers: 45000, views: 18000, cpm: 2.1, rank: 5 }
                ];

                container.innerHTML = channels.map(channel => `
                    <div class="performance-item">
                        <div class="performance-rank ${this.getRankClass(channel.rank)}">
                            ${channel.rank}
                        </div>
                        <div class="performance-info">
                            <div class="performance-name">${channel.name}</div>
                            <div class="performance-details">
                                ${this.formatNumber(channel.subscribers)} подписчиков
                            </div>
                        </div>
                        <div class="performance-metrics">
                            <div class="performance-metric">
                                <span class="performance-metric-value">${this.formatNumber(channel.views)}</span>
                                <span class="performance-metric-label">Просмотры</span>
                            </div>
                            <div class="performance-metric">
                                <span class="performance-metric-value">${channel.cpm}₽</span>
                                <span class="performance-metric-label">CPM</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            getRankClass(rank) {
                if (rank === 1) return 'gold';
                if (rank === 2) return 'silver';
                if (rank === 3) return 'bronze';
                return '';
            }

            startRealTimeUpdates() {
                this.updateInterval = setInterval(() => {
                    this.updateLastUpdateTime();
                    this.loadDashboardData();
                }, 60000); // Обновляем каждую минуту
            }

            updateLastUpdateTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('ru-RU', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                document.getElementById('last-update-time').textContent = timeString;
            }

            // Utility methods
            formatNumber(num) {
                if (num >= 1000000) {
                    return Math.floor(num / 100000) / 10 + 'M';
                }
                if (num >= 1000) {
                    return Math.floor(num / 100) / 10 + 'K';
                }
                return num.toString();
            }

            formatCurrency(amount) {
                return new Intl.NumberFormat('ru-RU', {
                    style: 'currency',
                    currency: 'RUB',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(amount);
            }

            calculateCPM() {
                const spent = this.data.offers?.total_budget || 0;
                const views = this.data.placements?.total_views || 0;
                if (views === 0) return 0;
                return (spent / views) * 1000;
            }

            calculateAvgCheck() {
                const total = this.data.offers?.total_budget || 0;
                const count = this.data.offers?.total || 0;
                return count > 0 ? total / count : 0;
            }
        }

        // Глобальные функции
        function changeChartPeriod(chartType, period) {
            // Обновляем активную кнопку
            const chartCard = document.querySelector(`#${chartType}Chart`).closest('.chart-card');
            chartCard.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Обновляем данные графика
            if (window.dashboard) {
                window.dashboard.updateCharts();
            }
        }

        function updateDateRange() {
            const dateFrom = document.getElementById('date-from').value;
            const dateTo = document.getElementById('date-to').value;
            
            if (dateFrom && dateTo) {
                console.log(`Обновление периода: ${dateFrom} - ${dateTo}`);
                if (window.dashboard) {
                    window.dashboard.loadDashboardData();
                }
            }
        }

        function setQuickRange(range) {
            const today = new Date();
            let startDate;
            
            switch (range) {
                case 'week':
                    startDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    startDate = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                    break;
                default:
                    startDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            }
            
            document.getElementById('date-from').value = startDate.toISOString().split('T')[0];
            document.getElementById('date-to').value = today.toISOString().split('T')[0];
            
            updateDateRange();
        }

        function exportData(format) {
            console.log(`Экспорт данных в формате: ${format}`);
            alert(`Экспорт в ${format.toUpperCase()} будет добавлен в следующем обновлении`);
        }

        function shareReport() {
            if (navigator.share) {
                navigator.share({
                    title: 'Отчет по рекламным кампаниям',
                    text: 'Статистика и аналитика рекламных кампаний',
                    url: window.location.href
                });
            } else {
                // Копируем ссылку в буфер обмена
                navigator.clipboard.writeText(window.location.href);
                alert('Ссылка скопирована в буфер обмена');
            }
        }

        // Инициализация
        document.addEventListener('DOMContentLoaded', () => {
            // Инициализация Telegram WebApp
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
            }
            
            // Инициализация дашборда
            window.dashboard = new StatisticsDashboard();
            
            // Устанавливаем текущее время
            const now = new Date();
            document.getElementById('last-update-time').textContent = now.toLocaleTimeString('ru-RU', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        });

        // Обработчики для улучшения UX
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Останавливаем обновления когда страница не видна
                if (window.dashboard && window.dashboard.updateInterval) {
                    clearInterval(window.dashboard.updateInterval);
                }
            } else {
                // Возобновляем обновления
                if (window.dashboard) {
                    window.dashboard.startRealTimeUpdates();
                    window.dashboard.loadDashboardData();
                }
            }
        });
    </script>
</body>
</html>
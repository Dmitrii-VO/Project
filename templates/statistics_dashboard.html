<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ - Telegram Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/variables.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/offers.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/offers_management.css') }}">
    
    <!-- Chart.js –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        /* –°—Ç–∏–ª–∏ –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
        .dashboard-header {
            background: var(--primary-gradient);
            color: white;
            padding: 24px;
            border-radius: var(--border-radius);
            margin-bottom: 24px;
            text-align: center;
        }
        
        .dashboard-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .dashboard-subtitle {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        
        .metric-card {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
        }
        
        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .metric-icon {
            font-size: 24px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 50%;
            color: var(--primary-color);
        }
        
        .metric-trend {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .metric-trend.positive {
            color: var(--success-color);
        }
        
        .metric-trend.negative {
            color: var(--danger-color);
        }
        
        .metric-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .metric-label {
            font-size: 14px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .metric-details {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }
        
        .metric-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
        }
        
        .metric-detail-label {
            color: var(--text-secondary);
        }
        
        .metric-detail-value {
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .charts-section {
            margin-bottom: 32px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
        }
        
        .chart-card {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .chart-filter {
            display: flex;
            gap: 8px;
        }
        
        .filter-btn {
            padding: 4px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .performance-table {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        
        .table-header {
            background: var(--bg-secondary);
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .table-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .table-content {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .performance-item {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            transition: var(--transition);
        }
        
        .performance-item:hover {
            background: var(--bg-secondary);
        }
        
        .performance-item:last-child {
            border-bottom: none;
        }
        
        .performance-rank {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            margin-right: 16px;
            flex-shrink: 0;
        }
        
        .performance-rank.gold {
            background: #ffd700;
            color: #000;
        }
        
        .performance-rank.silver {
            background: #c0c0c0;
            color: #000;
        }
        
        .performance-rank.bronze {
            background: #cd7f32;
            color: #fff;
        }
        
        .performance-info {
            flex: 1;
        }
        
        .performance-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .performance-details {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .performance-metrics {
            display: flex;
            gap: 16px;
            align-items: center;
        }
        
        .performance-metric {
            text-align: center;
            font-size: 12px;
        }
        
        .performance-metric-value {
            font-weight: 600;
            color: var(--text-primary);
            display: block;
        }
        
        .performance-metric-label {
            color: var(--text-secondary);
            margin-top: 2px;
        }
        
        .real-time-updates {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: 12px 16px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .real-time-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-color);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .export-panel {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 24px;
            text-align: center;
        }
        
        .export-buttons {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .date-range-selector {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: 16px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }
        
        .date-range-selector label {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .date-range-selector input {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-secondary);
        }
        
        .insights-panel {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 24px;
            border-left: 4px solid var(--primary-color);
        }
        
        .insights-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .insight-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .insight-icon {
            font-size: 16px;
            margin-top: 2px;
        }
        
        .insight-content {
            flex: 1;
        }
        
        .insight-text {
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        .insight-action {
            margin-top: 8px;
        }
        
        .insight-action .btn {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        @media (max-width: 768px) {
            .metrics-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .performance-metrics {
                flex-direction: column;
                gap: 8px;
            }
            
            .date-range-selector {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .export-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .real-time-updates {
                position: static;
                margin-bottom: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–∞—à–±–æ—Ä–¥–∞ -->
        <div class="dashboard-header">
            <div class="dashboard-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
            <div class="dashboard-subtitle">–ü–æ–¥—Ä–æ–±–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤–∞—à–∏—Ö —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π</div>
        </div>

        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ -->
        <div class="real-time-updates">
            <div class="real-time-indicator"></div>
            <span>–û–±–Ω–æ–≤–ª–µ–Ω–æ: <span id="last-update-time">--:--</span></span>
        </div>

        <!-- –°–µ–ª–µ–∫—Ç–æ—Ä –ø–µ—Ä–∏–æ–¥–∞ -->
        <div class="date-range-selector">
            <label>–ü–µ—Ä–∏–æ–¥:</label>
            <input type="date" id="date-from" class="form-input">
            <span>‚Äî</span>
            <input type="date" id="date-to" class="form-input">
            <button class="btn btn-primary" onclick="updateDateRange()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            <button class="btn btn-secondary" onclick="setQuickRange('week')">–ù–µ–¥–µ–ª—è</button>
            <button class="btn btn-secondary" onclick="setQuickRange('month')">–ú–µ—Å—è—Ü</button>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon">üéØ</div>
                    <div class="metric-trend positive">
                        <span>‚Üó</span> +12%
                    </div>
                </div>
                <div class="metric-value" id="total-offers">0</div>
                <div class="metric-label">–í—Å–µ–≥–æ –æ—Ñ—Ñ–µ—Ä–æ–≤</div>
                <div class="metric-details">
                    <div class="metric-detail-item">
                        <span class="metric-detail-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö:</span>
                        <span class="metric-detail-value" id="active-offers">0</span>
                    </div>
                    <div class="metric-detail-item">
                        <span class="metric-detail-label">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö:</span>
                        <span class="metric-detail-value" id="completed-offers">0</span>
                    </div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon">üì§</div>
                    <div class="metric-trend positive">
                        <span>‚Üó</span> +8%
                    </div>
                </div>
                <div class="metric-value" id="total-proposals">0</div>
                <div class="metric-label">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</div>
                <div class="metric-details">
                    <div class="metric-detail-item">
                        <span class="metric-detail-label">–ü—Ä–∏–Ω—è—Ç–æ:</span>
                        <span class="metric-detail-value" id="accepted-proposals">0</span>
                    </div>
                    <div class="metric-detail-item">
                        <span class="metric-detail-label">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ:</span>
                        <span class="metric-detail-value" id="rejected-proposals">0</span>
                    </div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon">üëÅ</div>
                    <div class="metric-trend positive">
                        <span>‚Üó</span> +23%
                    </div>
                </div>
                <div class="metric-value" id="total-views">0</div>
                <div class="metric-label">–í—Å–µ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</div>
                <div class="metric-details">
                    <div class="metric-detail-item">
                        <span class="metric-detail-label">–°–µ–≥–æ–¥–Ω—è:</span>
                        <span class="metric-detail-value" id="today-views">0</span>
                    </div>
                    <div class="metric-detail-item">
                        <span class="metric-detail-label">–°—Ä–µ–¥–Ω–∏–π CPM:</span>
                        <span class="metric-detail-value" id="avg-cpm">0‚ÇΩ</span>
                    </div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon">üí∞</div>
                    <div class="metric-trend negative">
                        <span>‚Üò</span> -5%
                    </div>
                </div>
                <div class="metric-value" id="total-spent">0‚ÇΩ</div>
                <div class="metric-label">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</div>
                <div class="metric-details">
                    <div class="metric-detail-item">
                        <span class="metric-detail-label">–≠—Ç–æ—Ç –º–µ—Å—è—Ü:</span>
                        <span class="metric-detail-value" id="month-spent">0‚ÇΩ</span>
                    </div>
                    <div class="metric-detail-item">
                        <span class="metric-detail-label">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫:</span>
                        <span class="metric-detail-value" id="avg-check">0‚ÇΩ</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
        <div class="charts-section">
            <h2 class="section-title">üìà –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π</h2>
            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">–ü—Ä–æ—Å–º–æ—Ç—Ä—ã –ø–æ –¥–Ω—è–º</div>
                        <div class="chart-filter">
                            <button class="filter-btn active" onclick="changeChartPeriod('views', '7d')">7–¥</button>
                            <button class="filter-btn" onclick="changeChartPeriod('views', '30d')">30–¥</button>
                            <button class="filter-btn" onclick="changeChartPeriod('views', '90d')">90–¥</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="viewsChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">–°—Ç–∞—Ç—É—Å—ã –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</div>
                        <div class="chart-filter">
                            <button class="filter-btn active" onclick="changeChartPeriod('proposals', 'all')">–í—Å–µ</button>
                            <button class="filter-btn" onclick="changeChartPeriod('proposals', 'month')">–ú–µ—Å—è—Ü</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="proposalsChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">–†–∞—Å—Ö–æ–¥—ã –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º</div>
                        <div class="chart-filter">
                            <button class="filter-btn active" onclick="changeChartPeriod('spending', 'daily')">–î–Ω–∏</button>
                            <button class="filter-btn" onclick="changeChartPeriod('spending', 'weekly')">–ù–µ–¥–µ–ª–∏</button>
                            <button class="filter-btn" onclick="changeChartPeriod('spending', 'monthly')">–ú–µ—Å—è—Ü—ã</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="spendingChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–∞–Ω–∞–ª–æ–≤</div>
                        <div class="chart-filter">
                            <button class="filter-btn active" onclick="changeChartPeriod('efficiency', 'cpm')">CPM</button>
                            <button class="filter-btn" onclick="changeChartPeriod('efficiency', 'views')">–ü—Ä–æ—Å–º–æ—Ç—Ä—ã</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="efficiencyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω—Å–∞–π—Ç—ã -->
        <div class="insights-panel">
            <div class="insights-title">
                <span>üîç</span> –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω—Å–∞–π—Ç—ã
            </div>
            <div id="insights-content">
                <div class="insight-item">
                    <div class="insight-icon">üìä</div>
                    <div class="insight-content">
                        <div class="insight-text">
                            –õ—É—á—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–ø–∞–Ω–∏–π: <strong>14:00-16:00</strong>. 
                            –í —ç—Ç–æ –≤—Ä–µ–º—è –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø—Ä–∏–Ω—è—Ç–∏—è –Ω–∞ 23% –≤—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ.
                        </div>
                        <div class="insight-action">
                            <button class="btn btn-primary">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∫–∞–º–ø–∞–Ω–∏—é</button>
                        </div>
                    </div>
                </div>
                
                <div class="insight-item">
                    <div class="insight-icon">üéØ</div>
                    <div class="insight-content">
                        <div class="insight-text">
                            –ö–∞–Ω–∞–ª—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏" –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –ª—É—á—à–∏–π ROI - 
                            —Å—Ä–µ–¥–Ω–∏–π CPM –Ω–∞ 15% –Ω–∏–∂–µ, —á–µ–º —É –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π.
                        </div>
                        <div class="insight-action">
                            <button class="btn btn-primary">–ù–∞–π—Ç–∏ tech-–∫–∞–Ω–∞–ª—ã</button>
                        </div>
                    </div>
                </div>
                
                <div class="insight-item">
                    <div class="insight-icon">‚ö°</div>
                    <div class="insight-content">
                        <div class="insight-text">
                            –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É–≤–µ–ª–∏—á–∏—Ç—å –±—é–¥–∂–µ—Ç –∫–∞–º–ø–∞–Ω–∏–∏ "#campaign_123" - 
                            –æ–Ω–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—Ç–ª–∏—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å –Ω–∏–∑–∫–∏–º CPM.
                        </div>
                        <div class="insight-action">
                            <button class="btn btn-primary">–£–≤–µ–ª–∏—á–∏—Ç—å –±—é–¥–∂–µ—Ç</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –¢–æ–ø –∫–∞–Ω–∞–ª—ã –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
        <div class="performance-table">
            <div class="table-header">
                <div class="table-title">üèÜ –¢–æ–ø –∫–∞–Ω–∞–ª—ã –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</div>
            </div>
            <div class="table-content" id="top-channels">
                <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ —á–µ—Ä–µ–∑ JavaScript -->
            </div>
        </div>

        <!-- –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö -->
        <div class="export-panel">
            <h3>üìã –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
            <div class="export-buttons">
                <button class="btn btn-secondary" onclick="exportData('csv')">
                    <span>üìÑ</span> –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
                </button>
                <button class="btn btn-secondary" onclick="exportData('excel')">
                    <span>üìä</span> –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
                </button>
                <button class="btn btn-secondary" onclick="exportData('pdf')">
                    <span>üìë</span> –û—Ç—á–µ—Ç –≤ PDF
                </button>
                <button class="btn btn-primary" onclick="shareReport()">
                    <span>üì§</span> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –æ—Ç—á–µ—Ç–æ–º
                </button>
            </div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∫—Ä–∏–ø—Ç—ã -->
    <script src="{{ url_for('static', filename='js/telegram-app.js') }}"></script>
    <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
    
    <script>
        class StatisticsDashboard {
            constructor() {
                this.charts = {};
                this.data = {};
                this.updateInterval = null;
                this.init();
            }

            init() {
                this.loadDashboardData();
                this.initCharts();
                this.startRealTimeUpdates();
                this.setDefaultDateRange();
            }

            setDefaultDateRange() {
                const today = new Date();
                const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                
                document.getElementById('date-from').value = weekAgo.toISOString().split('T')[0];
                document.getElementById('date-to').value = today.toISOString().split('T')[0];
            }

            async loadDashboardData() {
                try {
                    const response = await fetch('/api/statistics/dashboard');
                    const data = await response.json();
                    
                    if (data.success) {
                        this.data = data;
                        this.updateMetrics();
                        this.updateCharts();
                        this.updateTopChannels();
                    }
                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                }
            }

            updateMetrics() {
                const metrics = [
                    { id: 'total-offers', value: this.data.offers?.total || 0 },
                    { id: 'active-offers', value: this.data.offers?.active || 0 },
                    { id: 'completed-offers', value: this.data.offers?.completed || 0 },
                    { id: 'total-proposals', value: this.data.proposals?.total || 0 },
                    { id: 'accepted-proposals', value: this.data.proposals?.accepted || 0 },
                    { id: 'rejected-proposals', value: this.data.proposals?.rejected || 0 },
                    { id: 'total-views', value: this.formatNumber(this.data.placements?.total_views || 0) },
                    { id: 'today-views', value: this.formatNumber(this.data.placements?.today_views || 0) },
                    { id: 'total-spent', value: this.formatCurrency(this.data.offers?.total_budget || 0) },
                    { id: 'month-spent', value: this.formatCurrency(this.data.offers?.month_spent || 0) },
                    { id: 'avg-cpm', value: this.formatCurrency(this.calculateCPM()) },
                    { id: 'avg-check', value: this.formatCurrency(this.calculateAvgCheck()) }
                ];

                metrics.forEach(metric => {
                    const element = document.getElementById(metric.id);
                    if (element) {
                        this.animateValue(element, metric.value);
                    }
                });
            }

            animateValue(element, newValue) {
                const currentValue = element.textContent;
                element.textContent = newValue;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
                element.style.transform = 'scale(1.1)';
                element.style.transition = 'transform 0.3s ease';
                
                setTimeout(() => {
                    element.style.transform = 'scale(1)';
                }, 300);
            }

            initCharts() {
                // –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
                const viewsCtx = document.getElementById('viewsChart').getContext('2d');
                this.charts.views = new Chart(viewsCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: '–ü—Ä–æ—Å–º–æ—Ç—Ä—ã',
                            data: [],
                            borderColor: 'rgb(102, 126, 234)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                // –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (–ø–æ–Ω—á–∏–∫)
                const proposalsCtx = document.getElementById('proposalsChart').getContext('2d');
                this.charts.proposals = new Chart(proposalsCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['–ü—Ä–∏–Ω—è—Ç–æ', '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ', '–û–∂–∏–¥–∞–µ—Ç'],
                        datasets: [{
                            data: [0, 0, 0],
                            backgroundColor: [
                                'rgb(76, 175, 80)',
                                'rgb(244, 67, 54)',
                                'rgb(255, 193, 7)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });

                // –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤
                const spendingCtx = document.getElementById('spendingChart').getContext('2d');
                this.charts.spending = new Chart(spendingCtx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: '–†–∞—Å—Ö–æ–¥—ã',
                            data: [],
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: 'rgb(102, 126, 234)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                // –ì—Ä–∞—Ñ–∏–∫ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                const efficiencyCtx = document.getElementById('efficiencyChart').getContext('2d');
                this.charts.efficiency = new Chart(efficiencyCtx, {
                    type: 'radar',
                    data: {
                        labels: ['CPM', 'CTR', '–ö–æ–Ω–≤–µ—Ä—Å–∏—è', 'ROI', '–û—Ö–≤–∞—Ç'],
                        datasets: [{
                            label: '–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',
                            data: [0, 0, 0, 0, 0],
                            borderColor: 'rgb(102, 126, 234)',
                            backgroundColor: 'rgba(102, 126, 234, 0.2)',
                            pointBackgroundColor: 'rgb(102, 126, 234)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgb(102, 126, 234)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
            }

            updateCharts() {
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤
                this.updateViewsChart();
                this.updateProposalsChart();
                this.updateSpendingChart();
                this.updateEfficiencyChart();
            }

            updateViewsChart() {
                const chart = this.charts.views;
                if (!chart) return;

                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
                const labels = [];
                const data = [];
                
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    labels.push(date.toLocaleDateString('ru-RU', { month: 'short', day: 'numeric' }));
                    data.push(Math.floor(Math.random() * 1000) + 500);
                }

                chart.data.labels = labels;
                chart.data.datasets[0].data = data;
                chart.update();
            }

            updateProposalsChart() {
                const chart = this.charts.proposals;
                if (!chart) return;

                const accepted = this.data.proposals?.accepted || 0;
                const rejected = this.data.proposals?.rejected || 0;
                const pending = this.data.proposals?.pending || 0;

                chart.data.datasets[0].data = [accepted, rejected, pending];
                chart.update();
            }

            updateSpendingChart() {
                const chart = this.charts.spending;
                if (!chart) return;

                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥–æ–≤
                const labels = [];
                const data = [];
                
                for (let i = 29; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    labels.push(date.toLocaleDateString('ru-RU', { day: 'numeric' }));
                    data.push(Math.floor(Math.random() * 5000) + 1000);
                }

                chart.data.labels = labels;
                chart.data.datasets[0].data = data;
                chart.update();
            }

            updateEfficiencyChart() {
                const chart = this.charts.efficiency;
                if (!chart) return;

                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –º–µ—Ç—Ä–∏–∫–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                const cpm = this.calculateCPM();
                const ctr = Math.random() * 5 + 1; // –ü—Ä–∏–º–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                const conversion = Math.random() * 10 + 2;
                const roi = Math.random() * 150 + 50;
                const reach = Math.random() * 80 + 20;

                chart.data.datasets[0].data = [cpm, ctr, conversion, roi, reach];
                chart.update();
            }

            updateTopChannels() {
                const container = document.getElementById('top-channels');
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–æ–ø –∫–∞–Ω–∞–ª–æ–≤
                const channels = [
                    { name: 'TechNews Channel', subscribers: 125000, views: 45000, cpm: 0.8, rank: 1 },
                    { name: 'Business Today', subscribers: 89000, views: 32000, cpm: 1.2, rank: 2 },
                    { name: 'Crypto World', subscribers: 156000, views: 28000, cpm: 1.5, rank: 3 },
                    { name: 'Marketing Pro', subscribers: 67000, views: 22000, cpm: 1.8, rank: 4 },
                    { name: 'StartUp News', subscribers: 45000, views: 18000, cpm: 2.1, rank: 5 }
                ];

                container.innerHTML = channels.map(channel => `
                    <div class="performance-item">
                        <div class="performance-rank ${this.getRankClass(channel.rank)}">
                            ${channel.rank}
                        </div>
                        <div class="performance-info">
                            <div class="performance-name">${channel.name}</div>
                            <div class="performance-details">
                                ${this.formatNumber(channel.subscribers)} –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
                            </div>
                        </div>
                        <div class="performance-metrics">
                            <div class="performance-metric">
                                <span class="performance-metric-value">${this.formatNumber(channel.views)}</span>
                                <span class="performance-metric-label">–ü—Ä–æ—Å–º–æ—Ç—Ä—ã</span>
                            </div>
                            <div class="performance-metric">
                                <span class="performance-metric-value">${channel.cpm}‚ÇΩ</span>
                                <span class="performance-metric-label">CPM</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            getRankClass(rank) {
                if (rank === 1) return 'gold';
                if (rank === 2) return 'silver';
                if (rank === 3) return 'bronze';
                return '';
            }

            startRealTimeUpdates() {
                this.updateInterval = setInterval(() => {
                    this.updateLastUpdateTime();
                    this.loadDashboardData();
                }, 60000); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
            }

            updateLastUpdateTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('ru-RU', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                document.getElementById('last-update-time').textContent = timeString;
            }

            // Utility methods
            formatNumber(num) {
                if (num >= 1000000) {
                    return Math.floor(num / 100000) / 10 + 'M';
                }
                if (num >= 1000) {
                    return Math.floor(num / 100) / 10 + 'K';
                }
                return num.toString();
            }

            formatCurrency(amount) {
                return new Intl.NumberFormat('ru-RU', {
                    style: 'currency',
                    currency: 'RUB',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(amount);
            }

            calculateCPM() {
                const spent = this.data.offers?.total_budget || 0;
                const views = this.data.placements?.total_views || 0;
                if (views === 0) return 0;
                return (spent / views) * 1000;
            }

            calculateAvgCheck() {
                const total = this.data.offers?.total_budget || 0;
                const count = this.data.offers?.total || 0;
                return count > 0 ? total / count : 0;
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function changeChartPeriod(chartType, period) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
            const chartCard = document.querySelector(`#${chartType}Chart`).closest('.chart-card');
            chartCard.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞
            if (window.dashboard) {
                window.dashboard.updateCharts();
            }
        }

        function updateDateRange() {
            const dateFrom = document.getElementById('date-from').value;
            const dateTo = document.getElementById('date-to').value;
            
            if (dateFrom && dateTo) {
                console.log(`–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–∞: ${dateFrom} - ${dateTo}`);
                if (window.dashboard) {
                    window.dashboard.loadDashboardData();
                }
            }
        }

        function setQuickRange(range) {
            const today = new Date();
            let startDate;
            
            switch (range) {
                case 'week':
                    startDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    startDate = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                    break;
                default:
                    startDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            }
            
            document.getElementById('date-from').value = startDate.toISOString().split('T')[0];
            document.getElementById('date-to').value = today.toISOString().split('T')[0];
            
            updateDateRange();
        }

        function exportData(format) {
            console.log(`–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–æ—Ä–º–∞—Ç–µ: ${format}`);
            alert(`–≠–∫—Å–ø–æ—Ä—Ç –≤ ${format.toUpperCase()} –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏`);
        }

        function shareReport() {
            if (navigator.share) {
                navigator.share({
                    title: '–û—Ç—á–µ—Ç –ø–æ —Ä–µ–∫–ª–∞–º–Ω—ã–º –∫–∞–º–ø–∞–Ω–∏—è–º',
                    text: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π',
                    url: window.location.href
                });
            } else {
                // –ö–æ–ø–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
                navigator.clipboard.writeText(window.location.href);
                alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞—à–±–æ—Ä–¥–∞
            window.dashboard = new StatisticsDashboard();
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
            const now = new Date();
            document.getElementById('last-update-time').textContent = now.toLocaleTimeString('ru-RU', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è UX
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–≥–¥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –≤–∏–¥–Ω–∞
                if (window.dashboard && window.dashboard.updateInterval) {
                    clearInterval(window.dashboard.updateInterval);
                }
            } else {
                // –í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                if (window.dashboard) {
                    window.dashboard.startRealTimeUpdates();
                    window.dashboard.loadDashboardData();
                }
            }
        });
    </script>
</body>
</html>
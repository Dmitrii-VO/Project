<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ñ—Ñ–µ—Ä–∞–º–∏ - Telegram Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/variables.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/offers.css') }}">
    
    <!-- –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ñ—Ñ–µ—Ä–∞–º–∏ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/offers_management.css') }}">
</head>
<body>
    <div class="container">
        <!-- Hero Section –≤ —Å—Ç–∏–ª–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü -->
        <div class="hero-section">
            <button class="back-btn" onclick="goBack()">‚Üê –ù–∞–∑–∞–¥</button>
            <div class="hero-content">
                <span class="hero-icon">üéØ</span>
                <h1 class="hero-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ñ—Ñ–µ—Ä–∞–º–∏</h1>
                <p class="hero-subtitle">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∫–∞–º–ø–∞–Ω–∏–∏ –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</p>
            </div>
        </div>

        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ç–∞–±–∞–º –≤ —Å—Ç–∏–ª–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü -->
        <div class="navigation-grid">
            <div class="nav-card active" data-tab="my-offers" onclick="switchTab('my-offers')">
                <div class="nav-icon">üìã</div>
                <div class="nav-content">
                    <h3>–ú–æ–∏ –æ—Ñ—Ñ–µ—Ä—ã</h3>
                    <p>–°–ø–∏—Å–æ–∫ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π</p>
                </div>
            </div>
            <div class="nav-card" data-tab="statistics" onclick="switchTab('statistics')">
                <div class="nav-icon">üìä</div>
                <div class="nav-content">
                    <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                    <p>–û–±—â–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∫–∞–º–ø–∞–Ω–∏–π</p>
                </div>
            </div>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ "–ú–æ–∏ –æ—Ñ—Ñ–µ—Ä—ã" -->
        <div class="tab-content active" data-tab="my-offers">
            <!-- –ü–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π -->
            <div class="action-bar">
                <div class="search-container">
                    <span class="search-icon">üîç</span>
                    <input type="text" 
                           class="search-input" 
                           placeholder="–ü–æ–∏—Å–∫ –ø–æ –æ—Ñ—Ñ–µ—Ä–∞–º..."
                           onkeyup="filterOffers(this.value)">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="createNewOffer()">
                        <span>‚ûï</span> –°–æ–∑–¥–∞—Ç—å –æ—Ñ—Ñ–µ—Ä
                    </button>
                    <button class="btn btn-secondary" onclick="refreshOffers()">
                        <span>üîÑ</span> –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>
            </div>

            <!-- –§–∏–ª—å—Ç—Ä—ã -->
            <div class="filters-section">
                <div class="filter-group">
                    <label>–°—Ç–∞—Ç—É—Å:</label>
                    <select class="form-select" onchange="filterOffersByStatus(this.value)">
                        <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                        <option value="draft">–ß–µ—Ä–Ω–æ–≤–∏–∫–∏</option>
                        <option value="started">–ó–∞–ø—É—â–µ–Ω–Ω—ã–µ</option>
                        <option value="in_progress">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</option>
                        <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>–ü–µ—Ä–∏–æ–¥:</label>
                    <select class="form-select" onchange="filterOffersByPeriod(this.value)">
                        <option value="">–í—Å–µ –≤—Ä–µ–º—è</option>
                        <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
                        <option value="week">–ù–µ–¥–µ–ª—è</option>
                        <option value="month">–ú–µ—Å—è—Ü</option>
                    </select>
                </div>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –æ—Ñ—Ñ–µ—Ä–æ–≤ -->
            <div id="offers-container">
                <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –æ—Ñ—Ñ–µ—Ä—ã —á–µ—Ä–µ–∑ JavaScript -->
                <div class="loading-content">
                    <div class="loading-spinner"></div>
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ñ—Ñ–µ—Ä–æ–≤...</p>
                </div>
            </div>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞" -->
        <div class="tab-content" data-tab="statistics">
            <div class="statistics-section">
                <h2>üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                
                <!-- –û–±—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏ -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üéØ</div>
                        <div class="stat-content">
                            <div class="stat-number" id="total-offers">0</div>
                            <div class="stat-label">–í—Å–µ–≥–æ –æ—Ñ—Ñ–µ—Ä–æ–≤</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">üì§</div>
                        <div class="stat-content">
                            <div class="stat-number" id="total-proposals">0</div>
                            <div class="stat-label">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-content">
                            <div class="stat-number" id="acceptance-rate">0%</div>
                            <div class="stat-label">–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø—Ä–∏–Ω—è—Ç–∏—è</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">üëÅ</div>
                        <div class="stat-content">
                            <div class="stat-number" id="total-views">0</div>
                            <div class="stat-label">–û–±—â–∏–µ –ø—Ä–æ—Å–º–æ—Ç—Ä—ã</div>
                        </div>
                    </div>
                </div>

                <!-- –ì—Ä–∞—Ñ–∏–∫–∏ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
                <div class="analytics-section">
                    <h3>üìà –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –¥–Ω—è–º</h3>
                    <div class="chart-container">
                        <canvas id="offersChart" width="400" height="200"></canvas>
                    </div>
                </div>

                <!-- –¢–æ–ø –∫–∞–Ω–∞–ª—ã -->
                <div class="analytics-section">
                    <h3>üèÜ –¢–æ–ø –∫–∞–Ω–∞–ª—ã –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h3>
                    <div id="top-channels-list">
                        <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Å–ø–∏—Å–æ–∫ —Ç–æ–ø –∫–∞–Ω–∞–ª–æ–≤ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∫—Ä–∏–ø—Ç—ã -->
    <script src="{{ url_for('static', filename='js/telegram-app.js') }}"></script>
    <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/offers_management.js') }}"></script>
    
    <!-- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ñ—Ñ–µ—Ä–∞–º–∏
            if (window.OffersManagement) {
                window.offersManagement = new OffersManagement();
            }
        });

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–∞–±–∞–º–∏
        function switchTab(tabName) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
            document.querySelectorAll('.nav-card').forEach(card => {
                card.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelector(`.tab-content[data-tab="${tabName}"]`).classList.add('active');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
            if (tabName === 'statistics') {
                loadStatistics();
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        function filterOffers(searchText) {
            const offers = document.querySelectorAll('.offer-card');
            offers.forEach(offer => {
                const title = offer.querySelector('h3').textContent.toLowerCase();
                const description = offer.querySelector('.offer-description').textContent.toLowerCase();
                const searchLower = searchText.toLowerCase();
                
                if (title.includes(searchLower) || description.includes(searchLower)) {
                    offer.style.display = 'block';
                } else {
                    offer.style.display = 'none';
                }
            });
        }

        function filterOffersByStatus(status) {
            const offers = document.querySelectorAll('.offer-card');
            offers.forEach(offer => {
                if (!status || offer.querySelector('.offer-status').classList.contains(`status-${status}`)) {
                    offer.style.display = 'block';
                } else {
                    offer.style.display = 'none';
                }
            });
        }

        function filterOffersByPeriod(period) {
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –ø–µ—Ä–∏–æ–¥—É
            console.log('Filtering by period:', period);
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π
        function createNewOffer() {
            window.location.href = '/offers/create';
        }

        function refreshOffers() {
            if (window.offersManagement) {
                window.offersManagement.loadOffers();
            }
        }

        function goBack() {
            window.history.back();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function loadStatistics() {
            try {
                const response = await fetch('/api/statistics/dashboard');
                const data = await response.json();
                
                if (data.success) {
                    updateStatisticsDisplay(data);
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        function updateStatisticsDisplay(data) {
            document.getElementById('total-offers').textContent = data.offers.total;
            document.getElementById('total-proposals').textContent = data.proposals.total;
            document.getElementById('acceptance-rate').textContent = data.proposals.acceptance_rate + '%';
            document.getElementById('total-views').textContent = formatNumber(data.placements.total_views);
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                return Math.floor(num / 100000) / 10 + 'M';
            }
            if (num >= 1000) {
                return Math.floor(num / 100) / 10 + 'K';
            }
            return num.toString();
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è UX
        document.addEventListener('click', (e) => {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ —Ç–∞–±–∞–º –≤ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–Ω–∞—Ö
            if (e.target.matches('.tab-btn')) {
                const tabName = e.target.dataset.tab;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                e.target.classList.add('active');
                
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.querySelector(`.tab-content[data-tab="${tabName}"]`).classList.add('active');
            }
        });

        // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'n':
                        e.preventDefault();
                        createNewOffer();
                        break;
                    case 'r':
                        e.preventDefault();
                        refreshOffers();
                        break;
                    case 'f':
                        e.preventDefault();
                        document.querySelector('.search-input').focus();
                        break;
                }
            }
        });
    </script>
</body>
</html>
{% extends "base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ñ—Ñ–µ—Ä–∞–º–∏ - Telegram Mini App{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/offers-specific.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <!-- Hero Section -->
    <div class="hero-section animate-fade-in">
        <button class="back-btn" onclick="goBack()">‚Üê –ù–∞–∑–∞–¥</button>
        <div class="hero-content">
            <span class="hero-icon">üéØ</span>
            <h1 class="hero-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ñ—Ñ–µ—Ä–∞–º–∏</h1>
            <p class="hero-subtitle">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏ –∏—â–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –æ—Ñ—Ñ–µ—Ä—ã</p>
        </div>
    </div>

    <!-- –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–∞–±—ã -->
    <div class="tabs">
        <nav class="tabs-nav">
            <li><a href="#" class="active" data-tab="my-offers">–ú–æ–∏ –æ—Ñ—Ñ–µ—Ä—ã</a></li>
            <li><a href="#" data-tab="find-offer">–ù–∞–π—Ç–∏ –æ—Ñ—Ñ–µ—Ä</a></li>
            <li><a href="#" data-tab="create-offer">–°–æ–∑–¥–∞—Ç—å –æ—Ñ—Ñ–µ—Ä</a></li>
        </nav>
    </div>

    <!-- Tab: –ú–æ–∏ –æ—Ñ—Ñ–µ—Ä—ã -->
    <div class="tabs-content active" id="my-offers">
        <div class="form-field">
            <div style="position: relative; max-width: 400px;">
                <span style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-tertiary);">üîç</span>
                <input type="text" class="form-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –æ—Ñ—Ñ–µ—Ä–∞–º..." id="offersSearch" style="padding-left: 48px;">
            </div>
        </div>

        <div class="stats-grid" id="offersGrid">
            <div class="empty-state" style="grid-column: 1 / -1;" id="emptyOffersState">
                <div class="stat-icon">üìù</div>
                <h3>–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –æ—Ñ—Ñ–µ—Ä–æ–≤</h3>
                <p>–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π –æ—Ñ—Ñ–µ—Ä –¥–ª—è –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –∫–∞–Ω–∞–ª–æ–≤</p>
                <button class="btn btn-primary" onclick="switchTab('create-offer')">
                    ‚ûï –°–æ–∑–¥–∞—Ç—å –æ—Ñ—Ñ–µ—Ä
                </button>
            </div>
        </div>
    </div>

    <!-- Tab: –ù–∞–π—Ç–∏ –æ—Ñ—Ñ–µ—Ä -->
    <div class="tabs-content" id="find-offer">
        <div class="form-field">
            <div style="position: relative; max-width: 400px;">
                <span style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-tertiary);">üîç</span>
                <input type="text" class="form-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏..." id="findOffersSearch" style="padding-left: 48px;">
            </div>
        </div>

        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">üîß –§–∏–ª—å—Ç—Ä—ã</h3>
            </div>
            <div class="card-body">
                <div class="form-field">
                    <label class="form-label" for="findCategoryFilter">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <select class="form-select" id="findCategoryFilter">
                        <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                        <option value="tech">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</option>
                        <option value="finance">–§–∏–Ω–∞–Ω—Å—ã</option>
                        <option value="lifestyle">–°—Ç–∏–ª—å –∂–∏–∑–Ω–∏</option>
                        <option value="education">–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</option>
                        <option value="business">–ë–∏–∑–Ω–µ—Å</option>
                        <option value="entertainment">–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</option>
                    </select>
                </div>

                <div class="form-field">
                    <label class="form-label" for="findBudgetMin">–ë—é–¥–∂–µ—Ç</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="number" class="form-input" id="findBudgetMin" placeholder="–æ—Ç" min="0">
                        <input type="number" class="form-input" id="findBudgetMax" placeholder="–¥–æ" min="0">
                    </div>
                </div>

                <div class="form-field">
                    <label class="form-label" for="findMinSubscribers">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–∏</label>
                    <input type="number" class="form-input" id="findMinSubscribers" placeholder="–ú–∏–Ω. –ø–æ–¥–ø–∏—Å—á–∏–∫–∏" min="0">
                </div>

                <div class="form-field">
                    <div style="display: flex; gap: var(--space-2);">
                        <button class="btn btn-primary" onclick="applyFindFilters()">üîç –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                        <button class="btn btn-secondary" onclick="clearFindFilters()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
        <div id="findOffersGrid" class="stats-grid">
            <!-- –î–æ—Å—Ç—É–ø–Ω—ã–µ –æ—Ñ—Ñ–µ—Ä—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
        </div>

        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
        <div id="findOffersLoading" class="empty-state" style="display: none;">
            <div class="stat-icon">‚è≥</div>
            <h3>–ü–æ–∏—Å–∫ –æ—Ñ—Ñ–µ—Ä–æ–≤...</h3>
        </div>
    </div>

    <!-- Tab: –°–æ–∑–¥–∞—Ç—å –æ—Ñ—Ñ–µ—Ä -->
    <div class="tabs-content" id="create-offer">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">üéØ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥–±–æ—Ä –∫–∞–Ω–∞–ª–æ–≤</h3>
                <button class="modal-close" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-tertiary);">&times;</button>
            </div>
            <div class="card-body">
                <!-- –ü–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ -->
                <div style="margin-bottom: var(--space-6);">
                    <div style="display: flex; align-items: flex-start; gap: var(--space-3); margin-bottom: var(--space-4);">
                        <div style="background: var(--primary-100); border-radius: var(--radius-full); width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <span style="color: var(--primary-600); font-size: var(--text-lg);">üéØ</span>
                        </div>
                        <div>
                            <h4 style="margin: 0 0 var(--space-1) 0; font-size: var(--text-base); font-weight: 600; color: var(--text-primary);">1. –£–∫–∞–∂–∏—Ç–µ –±—é–¥–∂–µ—Ç –∫–∞–º–ø–∞–Ω–∏–∏ –∏ —Ç–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è.</h4>
                            <p style="margin: 0; font-size: var(--text-sm); color: var(--text-secondary); line-height: var(--leading-normal);">
                                –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è –∏–ª–∏ –∫–æ—Ä–æ—Ç–∫–æ –æ–ø–∏—à–∏—Ç–µ —Ç–æ, —á—Ç–æ –±—É–¥–µ—Ç–µ —Ä–µ–∫–ª–∞–º–∏—Ä–æ–≤–∞—Ç—å.
                            </p>
                            <p style="margin: var(--space-2) 0 0 0; font-size: var(--text-sm); color: var(--text-secondary); line-height: var(--leading-normal);">
                                –í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ —É–∫–∞–∑–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ —Å–∞–π—Ç: –æ–Ω –±—É–¥–µ—Ç –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–µ–ª–µ–≤–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏.
                            </p>
                        </div>
                    </div>

                    <div style="display: flex; align-items: flex-start; gap: var(--space-3);">
                        <div style="background: var(--primary-100); border-radius: var(--radius-full); width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <span style="color: var(--primary-600); font-size: var(--text-lg);">üöÄ</span>
                        </div>
                        <div>
                            <h4 style="margin: 0 0 var(--space-1) 0; font-size: var(--text-base); font-weight: 600; color: var(--text-primary);">2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø–æ–¥–±–æ—Ä.</h4>
                            <p style="margin: 0; font-size: var(--text-sm); color: var(--text-secondary); line-height: var(--leading-normal);">
                                –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –≤—ã —Å–º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º—ã—Ö –∫–∞–Ω–∞–ª–æ–≤, –¥–æ–±–∞–≤–∏—Ç—å –∏—Ö –≤ –∫–∞–º–ø–∞–Ω–∏—é –∏–ª–∏ –≤—ã–≥—Ä—É–∑–∏—Ç—å –º–µ–¥–∏–∞–ø–ª–∞–Ω.
                            </p>
                            <p style="margin: var(--space-2) 0 0 0; font-size: var(--text-sm); color: var(--text-secondary); line-height: var(--leading-normal);">
                                <strong>–ê–Ω–∞–ª–∏–∑ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –∏ –ø–æ–¥–±–æ—Ä –∫–∞–Ω–∞–ª–æ–≤ –æ–±—ã—á–Ω–æ –∑–∞–Ω–∏–º–∞–µ—Ç –æ–∫–æ–ª–æ 30 —Å–µ–∫—É–Ω–¥.</strong> –ó–∞ —ç—Ç–æ –≤—Ä–µ–º—è AI Gooroo Tools –∫–∞–∫ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ü–µ–ª–µ–≤—É—é –∞—É–¥–∏—Ç–æ—Ä–∏—é, —Ç–∞–∫ –∏ —É—á–∏—Ç—ã–≤–∞–µ—Ç –æ–ø—ã—Ç —É–∂–µ —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- –§–æ—Ä–º–∞ -->
                <form id="autoOfferForm">
                    <div class="form-field">
                        <label class="form-label form-label-required" for="offerBudget">–ë—é–¥–∂–µ—Ç:</label>
                        <input type="number" class="form-input" id="offerBudget" name="budget" placeholder="20000" min="1000" required>
                        <div class="form-help" style="margin-top: var(--space-1); font-size: var(--text-xs); color: var(--text-tertiary);">
                            –£–∫–∞–∂–∏—Ç–µ –±—é–¥–∂–µ—Ç, –∫–æ—Ç–æ—Ä—ã–π –≤—ã –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å –Ω–∞ –∫–∞–º–ø–∞–Ω–∏—é.
                            –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–±–µ—Ä–µ—Ç –∫–∞–Ω–∞–ª—ã –≤ —Ä–∞–º–∫–∞—Ö –±—é–¥–∂–µ—Ç–∞. –ï—Å–ª–∏ –∫–∞–∫–æ–π-—Ç–æ –∏–∑ –æ—Ç–æ–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –±–æ–ª—å—à–µ —á–µ–º-—Ç–æ, –µ–≥–æ
                            –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–∫–ª—é—á–∏—Ç—å —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ.
                        </div>
                    </div>

                    <div class="form-field">
                        <label class="form-label form-label-required" for="offerDescription">–û–±—ä—è–≤–ª–µ–Ω–∏–µ:</label>
                        <textarea class="form-textarea" id="offerDescription" name="description" placeholder="üéì –†–∞—Å–ø—Ä–æ–¥–∞–∂–∞ –û–Ω–ª–∞–π–Ω-–ö—É—Ä—Å–æ–≤! üéì" rows="4" required></textarea>
                        <div style="margin-top: var(--space-2);">
                            <div style="border: 1px solid var(--border-subtle); border-radius: var(--radius-md); background: var(--bg-secondary);">
                                <div style="padding: var(--space-3); border-bottom: 1px solid var(--border-subtle); font-weight: 500; font-size: var(--text-sm); color: var(--text-primary);">
                                    üìö –£–Ω–∏–∫–∞–ª—å–Ω–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è! –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤–∞–º –Ω–∞—à—É —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é –æ–Ω–ª–∞–π–Ω-–∫—É—Ä—Å–æ–≤ –ø–æ —Å–∞–º—ã–º —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–º —Ç–µ–º–∞–º ‚Äì –æ—Ç –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ –∫—É–ª–∏–Ω–∞—Ä–∏–∏!
                                </div>
                                <div style="padding: var(--space-3); border-bottom: 1px solid var(--border-subtle); font-size: var(--text-sm); color: var(--text-secondary);">
                                    üöÄ –°–∫–∏–¥–∫–∞ –¥–æ 50%! –ù–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–æ–≥–æ, –∏—â–µ—Ç–µ –ª–∏ –≤—ã –∫—É—Ä—Å –ø–æ —Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏—é, —Ö–æ—Ç–∏—Ç–µ –∏–∑—É—á–∏—Ç—å –Ω–æ–≤—ã–π —è–∑—ã–∫
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-field">
                        <button type="submit" class="btn btn-primary" style="width: 100%; background: var(--primary-500); border: none; padding: var(--space-3) var(--space-4); border-radius: var(--radius-md); color: white; font-weight: 500; cursor: pointer; transition: all var(--transition-fast);">
                            –ü–æ–¥–æ–±—Ä–∞—Ç—å –∫–∞–Ω–∞–ª—ã
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/utils.js') }}"></script>
<script src="{{ url_for('static', filename='js/offers.js') }}"></script>

<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
function goBack() {
    window.history.back();
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
function applyFindFilters() {
    console.log('–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ–∏—Å–∫–∞ –æ—Ñ—Ñ–µ—Ä–æ–≤');
    // –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
}

function clearFindFilters() {
    document.getElementById('findCategoryFilter').value = '';
    document.getElementById('findBudgetMin').value = '';
    document.getElementById('findBudgetMax').value = '';
    document.getElementById('findMinSubscribers').value = '';
    console.log('–§–∏–ª—å—Ç—Ä—ã –æ—á–∏—â–µ–Ω—ã');
}

// –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ñ—Ñ–µ—Ä–∞
async function submitAutoOffer(event) {
    event.preventDefault();
    
    const submitBtn = event.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    
    try {
        submitBtn.disabled = true;
        submitBtn.textContent = '‚è≥ –ü–æ–¥–±–∏—Ä–∞–µ–º –∫–∞–Ω–∞–ª—ã...';
        
        const formData = new FormData(event.target);
        const data = {
            title: '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥–±–æ—Ä –∫–∞–Ω–∞–ª–æ–≤',
            description: formData.get('description'),
            budget: parseInt(formData.get('budget')),
            price: Math.min(parseInt(formData.get('budget')) * 0.1, 50000),
            budget_total: parseInt(formData.get('budget')),
            target_audience: 'general',
            category: 'general',
            currency: 'RUB',
            content: formData.get('description')
        };
        
        console.log('üìã –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Ñ—Ñ–µ—Ä–∞:', data);
        
        const result = await ApiClient.post('/api/offers', data);
        
        if (result.success) {
            console.log('‚úÖ –û—Ñ—Ñ–µ—Ä —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ:', result.offer);
            showChannelSelectionModal(result.offer.id, result.offer.title);
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
            event.target.reset();
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–ú–æ–∏ –æ—Ñ—Ñ–µ—Ä—ã"
            switchTab('my-offers');
        } else {
            throw new Error(result.error || result.errors?.join(', ') || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ñ—Ñ–µ—Ä–∞');
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ—Ñ—Ñ–µ—Ä–∞:', error);
        alert(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –ø–æ —Ç–∞–±–∞–º
document.addEventListener('DOMContentLoaded', function() {
    console.log('üéØ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ñ—Ñ–µ—Ä–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');

    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤
    document.querySelectorAll('.tabs-nav a').forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            const tabName = this.getAttribute('data-tab');
            if (typeof switchTab === 'function') {
                switchTab(tabName);
            }
        });
    });
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ñ—Ñ–µ—Ä–∞
    const autoOfferForm = document.getElementById('autoOfferForm');
    if (autoOfferForm) {
        autoOfferForm.addEventListener('submit', submitAutoOffer);
    }
});
</script>
{% endblock %}
#!/usr/bin/env python3
"""
–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Telegram Mini App
–§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø - —É–±—Ä–∞–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
"""

import os
import sqlite3
import sys
import logging
from typing import Optional, Dict, Any
from datetime import datetime
from app.models.database import get_user_id_from_request, execute_db_query
from app.config.telegram_config import AppConfig
from app.api.offers import offers_bp
from app.routers.main_router import main_bp
from app.api.channels import channels_bp
import requests
from flask import Flask, jsonify, request, render_template


# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
try:
    from dotenv import load_dotenv

    load_dotenv()
except ImportError:
    print("‚ö†Ô∏è python-dotenv –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ")

# === –ù–ê–°–¢–†–û–ô–ö–ê –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø ===
def setup_logging() -> logging.Logger:
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏—Å—Ç–µ–º—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è"""
    logging.basicConfig(
        level=logging.INFO if not AppConfig.DEBUG else logging.DEBUG,
        format='%(asctime)s | %(name)-12s | %(levelname)-8s | %(message)s',
        datefmt='%Y-%m-%d %H:%M:%S'
    )

    logger = logging.getLogger('TelegramApp')
    logger.info("üìã –°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")
    return logger

# === –°–û–ó–î–ê–ù–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ===
def create_app() -> Flask:
    """–§–∞–±—Ä–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π"""

    app = Flask(__name__, static_folder= 'app/static', template_folder='templates')
    app.config.from_object(AppConfig)

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ JSON —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    app.json.ensure_ascii = False
    app.json.sort_keys = AppConfig.JSON_SORT_KEYS

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
    register_blueprints(app)
    register_middleware(app)
    register_error_handlers(app)
    register_system_routes(app)

    return app

# === –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø BLUEPRINTS ===
def register_blueprints(app: Flask) -> None:
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Blueprint'–æ–≤"""
    app.register_blueprint(offers_bp, url_prefix='/api/offers')
    app.register_blueprint(main_bp)
    app.register_blueprint(channels_bp, url_prefix='/api/channels')


# === MIDDLEWARE ===
def register_middleware(app: Flask) -> None:
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è middleware"""

    @app.before_request
    def security_middleware():
        if request.content_length and request.content_length > AppConfig.MAX_CONTENT_LENGTH:
            return jsonify({'error': 'Request too large'}), 413

    @app.after_request
    def security_headers(response):
        response.headers.update({
            'X-Content-Type-Options': 'nosniff',
            'X-Frame-Options': 'SAMEORIGIN',
            'X-XSS-Protection': '1; mode=block',
        })
        return response


# === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –û–®–ò–ë–û–ö ===
def register_error_handlers(app: Flask) -> None:
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –æ—à–∏–±–æ–∫"""

    @app.errorhandler(400)
    def bad_request(error):
        logger.warning(f"Bad request: {error} | Path: {request.path}")
        if request.path.startswith('/api/'):
            return jsonify({
                'error': 'Bad request',
                'message': '–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞',
                'path': request.path
            }), 400
        return render_template('error.html', 
                             message='–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞', 
                             code=400), 400

    @app.errorhandler(401)
    def unauthorized(error):
        logger.warning(f"Unauthorized access: {request.path} | User-Agent: {request.headers.get('User-Agent')}")
        if request.path.startswith('/api/'):
            return jsonify({
                'error': 'Unauthorized',
                'message': '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è',
                'path': request.path
            }), 401
        return render_template('error.html', 
                             message='–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram', 
                             code=401), 401

    @app.errorhandler(403)
    def forbidden(error):
        logger.warning(f"Forbidden access: {request.path} | Headers: {dict(request.headers)}")
        if request.path.startswith('/api/'):
            return jsonify({
                'error': 'Forbidden',
                'message': '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞',
                'path': request.path
            }), 403
        return render_template('error.html', 
                             message='–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞', 
                             code=403), 403

    @app.errorhandler(404)
    def not_found(error):
        logger.info(f"Not found: {request.path} | Method: {request.method}")
        if request.path.startswith('/api/'):
            return jsonify({
                'error': 'Endpoint not found', 
                'path': request.path,
                'method': request.method
            }), 404
        return render_template('error.html', 
                             message='–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 
                             code=404), 404

    @app.errorhandler(405)
    def method_not_allowed(error):
        logger.warning(f"Method not allowed: {request.method} {request.path}")
        if request.path.startswith('/api/'):
            return jsonify({
                'error': 'Method not allowed',
                'message': f'–ú–µ—Ç–æ–¥ {request.method} –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è',
                'path': request.path,
                'allowed_methods': error.valid_methods if hasattr(error, 'valid_methods') else []
            }), 405
        return render_template('error.html', 
                             message=f'–ú–µ—Ç–æ–¥ {request.method} –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 
                             code=405), 405

    @app.errorhandler(413)
    def request_entity_too_large(error):
        logger.warning(f"Request too large: {request.path} | Content-Length: {request.content_length}")
        if request.path.startswith('/api/'):
            return jsonify({
                'error': 'Request too large',
                'message': '–†–∞–∑–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–π',
                'max_size': f"{AppConfig.MAX_CONTENT_LENGTH // (1024*1024)}MB"
            }), 413
        return render_template('error.html', 
                             message='–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π', 
                             code=413), 413

    @app.errorhandler(429)
    def rate_limit_exceeded(error):
        logger.warning(f"Rate limit exceeded: {request.path} | IP: {request.remote_addr}")
        if request.path.startswith('/api/'):
            return jsonify({
                'error': 'Rate limit exceeded',
                'message': '–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤',
                'retry_after': getattr(error, 'retry_after', 60)
            }), 429
        return render_template('error.html', 
                             message='–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', 
                             code=429), 429

    @app.errorhandler(500)
    def internal_error(error):
        logger.error(f"Internal error: {error} | Path: {request.path} | Method: {request.method}")
        if request.path.startswith('/api/'):
            return jsonify({
                'error': 'Internal server error',
                'message': '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'
            }), 500
        return render_template('error.html', 
                             message='–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞', 
                             code=500), 500

    @app.errorhandler(502)
    def bad_gateway(error):
        logger.error(f"Bad gateway: {error} | Path: {request.path}")
        if request.path.startswith('/api/'):
            return jsonify({
                'error': 'Bad gateway',
                'message': '–°–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'
            }), 502
        return render_template('error.html', 
                             message='–°–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 
                             code=502), 502

    @app.errorhandler(503)
    def service_unavailable(error):
        logger.error(f"Service unavailable: {error} | Path: {request.path}")
        if request.path.startswith('/api/'):
            return jsonify({
                'error': 'Service unavailable',
                'message': '–°–µ—Ä–≤–∏—Å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏'
            }), 503
        return render_template('error.html', 
                             message='–°–µ—Ä–≤–∏—Å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏', 
                             code=503), 503

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ SQLite –æ—à–∏–±–æ–∫
    @app.errorhandler(sqlite3.Error)
    def database_error(error):
        logger.error(f"Database error: {error} | Path: {request.path} | Query context available")
        if request.path.startswith('/api/'):
            return jsonify({
                'error': 'Database error',
                'message': '–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö'
            }), 500
        return render_template('error.html', 
                             message='–í—Ä–µ–º–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', 
                             code=500), 500

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ JSON –æ—à–∏–±–æ–∫
    @app.errorhandler(400)
    def handle_json_error(error):
        if 'application/json' in request.content_type:
            logger.warning(f"Invalid JSON: {request.path} | Error: {error}")
            return jsonify({
                'error': 'Invalid JSON',
                'message': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON –¥–∞–Ω–Ω—ã—Ö'
            }), 400
        return bad_request(error)

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
    try:
        from werkzeug.exceptions import UnprocessableEntity
        
        @app.errorhandler(422)
        def validation_error(error):
            logger.warning(f"Validation error: {error} | Path: {request.path}")
            if request.path.startswith('/api/'):
                return jsonify({
                    'error': 'Validation failed',
                    'message': '–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö',
                    'details': getattr(error, 'data', {})
                }), 422
            return render_template('error.html', 
                                 message='–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö', 
                                 code=422), 422
    except ImportError:
        pass

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ Telegram API (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
    try:
        import telegram
        
        @app.errorhandler(telegram.error.TelegramError)
        def telegram_error(error):
            logger.error(f"Telegram API error: {error} | Path: {request.path}")
            if request.path.startswith('/api/'):
                return jsonify({
                    'error': 'Telegram API error',
                    'message': '–û—à–∏–±–∫–∞ Telegram API'
                }), 503
            return render_template('error.html', 
                                 message='–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å Telegram', 
                                 code=503), 503
    except ImportError:
        pass

    # –û–±—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π
    @app.errorhandler(Exception)
    def handle_unexpected_error(error):
        logger.error(f"Unexpected error: {type(error).__name__}: {error} | Path: {request.path}")
        logger.error(f"Traceback: ", exc_info=True)
        
        if request.path.startswith('/api/'):
            return jsonify({
                'error': 'Unexpected error',
                'message': '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞'
            }), 500
        return render_template('error.html', 
                             message='–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞', 
                             code=500), 500

    logger.info("‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—à–∏–±–æ–∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã")


# === –°–õ–£–ñ–ï–ë–ù–´–ï –ú–ê–†–®–†–£–¢–´ ===
def register_system_routes(app: Flask) -> None:
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–ª—É–∂–µ–±–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤"""

    # === –ú–ê–†–®–†–£–¢–´ –ó–î–û–†–û–í–¨–Ø –°–ò–°–¢–ï–ú–´ ===
    
    @app.route('/health')
    @app.route('/api/health')
    def health_check():
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã"""
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ë–î
            db_status = 'healthy'
            try:
                execute_db_query("SELECT 1", fetch_one=True)
            except Exception as e:
                db_status = f'unhealthy: {str(e)}'
                logger.error(f"Database health check failed: {e}")

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É
            fs_status = 'healthy' if os.path.exists(AppConfig.DATABASE_PATH) else 'database_missing'

            status = {
                'status': 'healthy' if db_status == 'healthy' else 'degraded',
                'timestamp': datetime.utcnow().isoformat(),
                'version': '1.0.0',
                'telegram_webapp': True,
                'services': {
                    'database': db_status,
                    'filesystem': fs_status,
                    'bot_configured': bool(AppConfig.BOT_TOKEN)
                }
            }

            status_code = 200 if status['status'] == 'healthy' else 503
            return jsonify(status), status_code

        except Exception as e:
            logger.error(f"Health check failed: {e}")
            return jsonify({
                'status': 'unhealthy',
                'error': str(e),
                'timestamp': datetime.utcnow().isoformat()
            }), 503

    # === –ú–ê–†–®–†–£–¢–´ –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò ===

    @app.route('/api/config')
    def get_app_config():
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø—É–±–ª–∏—á–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
        try:
            config = {
                'app_name': 'Telegram Mini App',
                'version': '1.0.0',
                'api_version': 'v1',
                'features': {
                    'channels': True,
                    'offers': True,
                    'analytics': True,
                    'payments': True,
                    'notifications': True
                },
                'limits': {
                    'max_channels_per_user': 10,
                    'max_offers_per_user': 50,
                    'max_file_size': AppConfig.MAX_CONTENT_LENGTH,
                    'supported_file_types': ['jpg', 'jpeg', 'png', 'gif', 'mp4']
                },
                'telegram': {
                    'webapp_url': AppConfig.WEBAPP_URL,
                    'bot_configured': bool(AppConfig.BOT_TOKEN)
                }
            }

            return jsonify({
                'success': True,
                'config': config,
                'timestamp': datetime.utcnow().isoformat()
            })

        except Exception as e:
            logger.error(f"Config fetch failed: {e}")
            return jsonify({'success': False, 'error': str(e)}), 500


    # === –ú–ê–†–®–†–£–¢–´ –°–¢–ê–¢–ò–°–¢–ò–ö–ò ===

    @app.route('/api/stats/global')
    def get_global_stats():
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã"""
        try:
            stats = {
                'channels': 0,
                'users': 0,
                'offers': 0,
                'revenue': 0
            }

            # –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–æ–¥—Å—á–µ—Ç —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
            try:
                result = execute_db_query("SELECT COUNT(*) as count FROM channels WHERE is_active = 1", fetch_one=True)
                stats['channels'] = result['count'] if result else 0
            except:
                pass

            try:
                result = execute_db_query("SELECT COUNT(*) as count FROM users WHERE is_active = 1", fetch_one=True)
                stats['users'] = result['count'] if result else 0
            except:
                pass

            try:
                result = execute_db_query("SELECT COUNT(*) as count FROM offers WHERE status = 'active'", fetch_one=True)
                stats['offers'] = result['count'] if result else 0
            except:
                pass

            try:
                result = execute_db_query("SELECT COALESCE(SUM(price), 0) as total FROM offers WHERE status = 'active'", fetch_one=True)
                stats['revenue'] = float(result['total']) if result and result['total'] else 0
            except:
                pass

            return jsonify({
                'success': True,
                'stats': stats,
                'timestamp': datetime.utcnow().isoformat()
            })

        except Exception as e:
            logger.error(f"Global stats failed: {e}")
            return jsonify({'success': False, 'error': str(e)}), 500

    # === WEBHOOK –ú–ê–†–®–†–£–¢–´ ===

    @app.route('/webhook/telegram', methods=['POST'])
    def telegram_webhook():
        """
        –ï–î–ò–ù–´–ô WEBHOOK –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ Telegram –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
        –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ —Ç–∏–ø–∞–º –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        """
        try:
            update = request.get_json()
            
            if not update:
                return jsonify({'ok': True})

            logger.info(f"üîî –ü–æ–ª—É—á–µ–Ω–æ Telegram –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: {update.get('update_id', 'unknown')}")
            
            # === –û–ë–†–ê–ë–û–¢–ö–ê –ü–õ–ê–¢–ï–ñ–ï–ô ===
            if 'pre_checkout_query' in update or ('message' in update and 'successful_payment' in update.get('message', {})):
                logger.info("üí≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–ª–∞—Ç–µ–∂–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ")
                return handle_payment_webhook(update)
            
            # === –û–ë–†–ê–ë–û–¢–ö–ê –°–û–û–ë–©–ï–ù–ò–ô –í –ö–ê–ù–ê–õ–ê–• (–≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è) ===
            if 'channel_post' in update:
                logger.info("üì¢ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–∞–Ω–∞–ª–µ")
                return handle_channel_verification(update)
            
            # === –û–ë–†–ê–ë–û–¢–ö–ê –õ–ò–ß–ù–´–• –°–û–û–ë–©–ï–ù–ò–ô –ë–û–¢–£ ===
            if 'message' in update:
                message = update['message']
                
                # –ö–æ–º–∞–Ω–¥–∞ /start
                if message.get('text') == '/start':
                    logger.info("üöÄ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—É /start")
                    return handle_start_command(update)
                
                # –ü–µ—Ä–µ—Å–ª–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
                if 'forward_from_chat' in message:
                    logger.info("üì§ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–µ—Ä–µ—Å–ª–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ")
                    return handle_forwarded_message(update)
            
            # === –û–ë–†–ê–ë–û–¢–ö–ê CALLBACK QUERY ===
            if 'callback_query' in update:
                logger.info("üîò –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º callback query")
                return handle_callback_query(update)
            
            # –ï—Å–ª–∏ —Ç–∏–ø –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω - –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º OK
            logger.info(f"‚ùì –ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π —Ç–∏–ø –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: {list(update.keys())}")
            return jsonify({'ok': True})

        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ webhook: {e}")
            return jsonify({'ok': True})  # –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º ok –¥–ª—è Telegram

    def handle_payment_webhook(update):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π"""
        try:
            from app.routers.payment_router import process_payment_update
            return process_payment_update(update)
        except ImportError:
            logger.warning("‚ö†Ô∏è Payment router –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return jsonify({'ok': True})

    def handle_channel_verification(update):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫–∞–Ω–∞–ª–æ–≤ —á–µ—Ä–µ–∑ channel_post"""
        try:
            message = update['channel_post']
            chat = message.get('chat', {})
            chat_id = str(chat.get('id'))
            text = message.get('text', '')

            logger.info(f"üì¢ –°–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –∫–∞–Ω–∞–ª–∞ {chat_id}: {text[:50]}...")

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥—ã –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
            result = execute_db_query(
                "SELECT * FROM channels WHERE telegram_id = ? AND is_verified = 0 AND verification_code IS NOT NULL",
                (chat_id,),
                fetch_all=True
            )

            for channel in result:
                if channel['verification_code'] in text:
                    # –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –∫–∞–Ω–∞–ª
                    execute_db_query(
                        "UPDATE channels SET is_verified = 1, verified_at = ? WHERE id = ?",
                        (datetime.utcnow().isoformat(), channel['id'])
                    )
                    logger.info(f"‚úÖ –ö–∞–Ω–∞–ª {channel['id']} –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω")

            return jsonify({'ok': True})

        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫–∞–Ω–∞–ª–∞: {e}")
            return jsonify({'ok': True})

    def handle_start_command(update):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start"""
        try:
            import requests
            
            message = update['message']
            from_user_id = str(message['from']['id'])
            
            bot_token = AppConfig.BOT_TOKEN
            if not bot_token:
                return jsonify({'ok': True})
            
            send_url = f"https://api.telegram.org/bot{bot_token}/sendMessage"
            
            welcome_message = """üëã <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</b>

    –Ø –ø–æ–º–æ–≥—É –≤–∞–º –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –≤–∞—à–∏ Telegram –∫–∞–Ω–∞–ª—ã.

    <b>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</b>
    1Ô∏è‚É£ –î–æ–±–∞–≤—å—Ç–µ –∫–∞–Ω–∞–ª –≤ Mini App
    2Ô∏è‚É£ –ü–æ–ª—É—á–∏—Ç–µ –∫–æ–¥ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏  
    3Ô∏è‚É£ –û–ø—É–±–ª–∏–∫—É–π—Ç–µ –∫–æ–¥ –≤ –≤–∞—à–µ–º –∫–∞–Ω–∞–ª–µ
    4Ô∏è‚É£ –ü–µ—Ä–µ—Å–ª–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ–¥–æ–º –º–Ω–µ

    –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä—è–º–æ –∑–¥–µ—Å—å!"""

            requests.post(send_url, json={
                'chat_id': from_user_id,
                'text': welcome_message,
                'parse_mode': 'HTML'
            }, timeout=5)
            
            return jsonify({'ok': True})

        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ /start: {e}")
            return jsonify({'ok': True})

    def handle_forwarded_message(update):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ—Å–ª–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º –ª–æ–≥–æ–º"""
        try:
            message = update.get('message', {})
            forwarded_chat = message.get('forward_from_chat', {})
            text = message.get('text', '')

            logger.info("üì® –ü–æ–ª—É—á–µ–Ω–æ –ø–µ—Ä–µ—Å–ª–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:")
            logger.info(f"  üîπ –¢–µ–∫—Å—Ç: {text}")
            logger.info(f"  üîπ forward_from_chat: {forwarded_chat}")

            chat_id = str(forwarded_chat.get('id', ''))
            username = forwarded_chat.get('username', '')

            result = None

            if chat_id:
                logger.info(f"üîç –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∫–∞–Ω–∞–ª –ø–æ telegram_id = {chat_id}")
                result = execute_db_query(
                    "SELECT * FROM channels WHERE telegram_id = ? AND is_verified = 0",
                    (chat_id,),
                    fetch_one=True
                )

            if not result and username:
                logger.info(f"üîç –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∫–∞–Ω–∞–ª –ø–æ username = {username}")
                result = execute_db_query(
                    "SELECT * FROM channels WHERE username = ? AND is_verified = 0",
                    (username,),
                    fetch_one=True
                )

            if not result:
                logger.warning("‚ùå –ö–∞–Ω–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –ø–æ ID –∏–ª–∏ username")
            elif result['verification_code'] not in text:
                logger.warning(f"‚ùå –ö–æ–¥ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ç–µ–∫—Å—Ç–µ. –û–∂–∏–¥–∞–ª–∏: {result['verification_code']}")
            else:
                execute_db_query(
                    "UPDATE channels SET is_verified = 1, verified_at = ? WHERE id = ?",
                    (datetime.utcnow().isoformat(), result['id'])
                )
                logger.info(f"‚úÖ –ö–∞–Ω–∞–ª {result['id']} —É—Å–ø–µ—à–Ω–æ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ –ø–µ—Ä–µ—Å—ã–ª–∫—É")

            return jsonify({'ok': True})

        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–µ—Ä–µ—Å–ª–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}", exc_info=True)
            return jsonify({'ok': True})



    def handle_callback_query(update):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ inline –∫–Ω–æ–ø–æ–∫"""
        try:
            # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É inline –∫–Ω–æ–ø–æ–∫
            return jsonify({'ok': True})
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ callback: {e}")
            return jsonify({'ok': True})


    # === –°–õ–£–ñ–ï–ë–ù–´–ï –ú–ê–†–®–†–£–¢–´ ===

    @app.route('/api/system/info')
    def system_info():
        """–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ"""
        try:
            import platform
            import sys

            info = {
                'python_version': sys.version,
                'platform': platform.platform(),
                'architecture': platform.architecture(),
                'hostname': platform.node(),
                'app_config': {
                    'debug': AppConfig.DEBUG,
                    'database_path': AppConfig.DATABASE_PATH,
                    'webapp_url': AppConfig.WEBAPP_URL
                }
            }

            return jsonify({
                'success': True,
                'system_info': info,
                'timestamp': datetime.utcnow().isoformat()
            })

        except Exception as e:
            logger.error(f"System info failed: {e}")
            return jsonify({'success': False, 'error': str(e)}), 500

    @app.route('/api/test/connection')
    def test_connection():
        """–¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏ –±–∞–∑–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏"""
        try:
            # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
            tests = {
                'database': False,
                'filesystem': False,
                'config': False
            }

            # –¢–µ—Å—Ç –ë–î
            try:
                execute_db_query("SELECT 1", fetch_one=True)
                tests['database'] = True
            except:
                pass

            # –¢–µ—Å—Ç —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
            try:
                tests['filesystem'] = os.path.exists(AppConfig.DATABASE_PATH)
            except:
                pass

            # –¢–µ—Å—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
            try:
                tests['config'] = bool(AppConfig.BOT_TOKEN)
            except:
                pass

            success = all(tests.values())

            return jsonify({
                'success': success,
                'tests': tests,
                'message': 'All tests passed' if success else 'Some tests failed',
                'timestamp': datetime.utcnow().isoformat()
            })

        except Exception as e:
            logger.error(f"Connection test failed: {e}")
            return jsonify({'success': False, 'error': str(e)}), 500

    # === –°–õ–£–ñ–ï–ë–ù–´–ï –°–¢–†–ê–ù–ò–¶–´ ===

    @app.route('/robots.txt')
    def robots_txt():
        """Robots.txt –¥–ª—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º"""
        return """User-agent: *
Disallow: /api/
Disallow: /admin/
Allow: /
""", 200, {'Content-Type': 'text/plain'}

    @app.route('/favicon.ico')
    def favicon():
        """Favicon redirect"""
        return '', 204

    logger.info("‚úÖ –°–ª—É–∂–µ–±–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã")




# === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
logger = setup_logging()
app = create_app()

# === –¢–û–ß–ö–ê –í–•–û–î–ê ===
def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞"""

    if not AppConfig.validate():
        logger.error("‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏")
        sys.exit(1)
    host = os.environ.get('HOST', '0.0.0.0')
    port = int(os.environ.get('PORT', 5000))

    logger.info("=" * 60)
    logger.info("üöÄ TELEGRAM MINI APP - –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø –í–ï–†–°–ò–Ø")
    logger.info("=" * 60)
    logger.info(f"üì± BOT_TOKEN: {'‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω' if AppConfig.BOT_TOKEN else '‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}")
    logger.info(f"üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: {AppConfig.DATABASE_PATH}")
    logger.info(f"üåê –ó–∞–ø—É—Å–∫ –Ω–∞: http://{host}:{port}")

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –º–∞—Ä—à—Ä—É—Ç–æ–≤
    total_routes = len(list(app.url_map.iter_rules()))
    offers_routes = len([r for r in app.url_map.iter_rules() if '/api/offers' in r.rule])
    logger.info(f"üìä –í—Å–µ–≥–æ –º–∞—Ä—à—Ä—É—Ç–æ–≤: {total_routes} (offers: {offers_routes})")
    logger.info("=" * 60)
    logger.info(f"üì° WEBAPP_URL = {AppConfig.WEBAPP_URL}")

    # === –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Webhook –¥–ª—è Telegram ===
    try:
        bot_token = AppConfig.BOT_TOKEN
        webhook_url = f"{AppConfig.WEBAPP_URL}/webhook/telegram"

        response = requests.get(
            f"https://api.telegram.org/bot{bot_token}/setWebhook",
            params={'url': webhook_url},
            timeout=10
        )

        if response.status_code == 200 and response.json().get("ok"):
            logger.info(f"‚úÖ Webhook —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {webhook_url}")
        else:
            logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å webhook: {response.text}")
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ webhook: {e}")

    try:
        app.run(
            host=host,
            port=port,
            debug=AppConfig.DEBUG,
            threaded=True,
            use_reloader=AppConfig.DEBUG
        )
    except KeyboardInterrupt:
        logger.info("üõë –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        sys.exit(1)


if __name__ == '__main__':
    main()